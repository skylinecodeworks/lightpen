=== √Årbol de directorios (sin .venv) ===
.
‚îú‚îÄ‚îÄ alembic
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ env.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __pycache__
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ env.cpython-312.pyc
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ README
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ script.py.mako
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ versions
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ 1cb3e4a64fe7_initial_schema.py
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ 7a1abb918f48_initial_schema.py
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ c07fcca22c82_initial_schema.py
‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ __pycache__
‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ 1cb3e4a64fe7_initial_schema.cpython-312.pyc
‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ 7a1abb918f48_initial_schema.cpython-312.pyc
‚îÇ¬†¬†         ‚îî‚îÄ‚îÄ c07fcca22c82_initial_schema.cpython-312.pyc
‚îú‚îÄ‚îÄ alembic.ini
‚îú‚îÄ‚îÄ alembic.sh
‚îú‚îÄ‚îÄ app
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ core
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ auth.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ config.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ db.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ pdf_generator.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ __pycache__
‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ auth.cpython-312.pyc
‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ config.cpython-312.pyc
‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ db.cpython-312.pyc
‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ __init__.cpython-312.pyc
‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ pdf_generator.cpython-312.pyc
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ models.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __pycache__
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.cpython-312.pyc
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ models.cpython-312.pyc
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ schemas.cpython-312.pyc
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ routes
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ invoices.py
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __pycache__
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.cpython-312.pyc
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ invoices.cpython-312.pyc
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ receipts.cpython-312.pyc
‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ receipts.py
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ schemas.py
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ services
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ __init__.py
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ lnd_grpc.py
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ lnd.py.orig
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ lnd.py.rej
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ __pycache__
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ __init__.cpython-312.pyc
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ lnd_grpc.cpython-312.pyc
‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ stripe.py
‚îú‚îÄ‚îÄ docker
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ lnd
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ docker-compose.yml
‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ lnd1-data
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ data
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ chain
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ bitcoin
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ regtest
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ admin.macaroon
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ chainnotifier.macaroon
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ channel.backup
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ invoice.macaroon
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ invoices.macaroon
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ macaroons.db
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ readonly.macaroon
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ router.macaroon
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ signer.macaroon
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ wallet.db
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îî‚îÄ‚îÄ walletkit.macaroon
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ graph
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ regtest
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ channel.db
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ sphinxreplay.db
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ watchtower
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ bitcoin
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îî‚îÄ‚îÄ regtest
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ letsencrypt
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ logs
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ bitcoin
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ regtest
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îî‚îÄ‚îÄ lnd.log
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ tls.cert
‚îÇ¬†¬†     ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ tls.key
‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ lnd2-data
‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ data
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ chain
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ bitcoin
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ regtest
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ admin.macaroon
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ chainnotifier.macaroon
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ channel.backup
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ invoice.macaroon
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ invoices.macaroon
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ macaroons.db
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ readonly.macaroon
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ router.macaroon
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ signer.macaroon
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ wallet.db
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îÇ¬†¬†         ‚îî‚îÄ‚îÄ walletkit.macaroon
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îú‚îÄ‚îÄ graph
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ regtest
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îú‚îÄ‚îÄ channel.db
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ sphinxreplay.db
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ watchtower
‚îÇ¬†¬†         ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ bitcoin
‚îÇ¬†¬†         ‚îÇ¬†¬†         ‚îî‚îÄ‚îÄ regtest
‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ letsencrypt
‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ logs
‚îÇ¬†¬†         ‚îÇ¬†¬† ‚îî‚îÄ‚îÄ bitcoin
‚îÇ¬†¬†         ‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ regtest
‚îÇ¬†¬†         ‚îÇ¬†¬†         ‚îî‚îÄ‚îÄ lnd.log
‚îÇ¬†¬†         ‚îú‚îÄ‚îÄ tls.cert
‚îÇ¬†¬†         ‚îî‚îÄ‚îÄ tls.key
‚îú‚îÄ‚îÄ docker-compose.yml
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ docs
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ openapi
‚îÇ¬†¬†     ‚îî‚îÄ‚îÄ openapi.yml
‚îú‚îÄ‚îÄ export_project.sh
‚îú‚îÄ‚îÄ generated_receipts
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ 162f077d-f0d7-44c2-8695-d72011713b3b.pdf
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ 28e6c66a-c16a-4d46-b71f-0cb363bc2410.pdf
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ 6d8c8640-5faa-447e-8a76-19d56fe0bd78.pdf
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ 9017b374-8cce-4395-a4b3-1a3b37c511a3.pdf
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ 92d1135f-965b-4728-8501-fadbc00ca9c8.pdf
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ 9cb44fcf-a6ae-4132-bb66-fa5650ee0154.pdf
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ bd52990e-ba78-448f-8345-209ca94e8de1.pdf
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ c38cf24f-f446-4a44-8c1c-6242fe44246e.pdf
‚îÇ¬†¬† ‚îú‚îÄ‚îÄ c57b7aa6-cbc7-4536-acec-76c9684381de.pdf
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ dbeea520-1ae7-4087-bcea-9f7277e87ee9.pdf
‚îú‚îÄ‚îÄ init_lightning_stack.py
‚îú‚îÄ‚îÄ lightpen_test_log.txt
‚îú‚îÄ‚îÄ main.py
‚îú‚îÄ‚îÄ project_full.txt
‚îú‚îÄ‚îÄ __pycache__
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ main.cpython-312.pyc
‚îú‚îÄ‚îÄ pyproject.toml
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ seed_data.py
‚îú‚îÄ‚îÄ templates
‚îÇ¬†¬† ‚îî‚îÄ‚îÄ receipt.html
‚îú‚îÄ‚îÄ test_grpc_add_invoice.py
‚îú‚îÄ‚îÄ test.py
‚îî‚îÄ‚îÄ uv.lock

48 directories, 101 files


=== Contenido de ficheros (sin .venv) ===

----- Fichero: ./alembic/env.py -----
import os
import sys
from logging.config import fileConfig

from sqlalchemy import engine_from_config, pool
from alembic import context

# A√±adimos la carpeta ra√≠z al sys.path para importar 'app'
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

# Cargamos variables de entorno (.env)
from dotenv import load_dotenv
load_dotenv()

# Importamos el Base y los modelos
from app.core.db import Base
from app.models import Invoice, Receipt  # agreg√° aqu√≠ m√°s modelos si los vas creando

# Configuraci√≥n de Alembic
config = context.config

# Sobrescribimos la URL usando la del .env
config.set_main_option("sqlalchemy.url", os.getenv("DATABASE_URL"))

# Logging
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# MetaData
target_metadata = Base.metadata


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode."""
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )
    with context.begin_transaction():
        context.run_migrations()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode."""
    connectable = engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )
    with connectable.connect() as connection:
        context.configure(
            connection=connection, target_metadata=target_metadata
        )
        with context.begin_transaction():
            context.run_migrations()


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()

----- Fichero: ./alembic/versions/1cb3e4a64fe7_initial_schema.py -----
"""initial schema

Revision ID: 1cb3e4a64fe7
Revises: c07fcca22c82
Create Date: 2025-05-09 18:25:35.107364

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '1cb3e4a64fe7'
down_revision: Union[str, None] = 'c07fcca22c82'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###


----- Fichero: ./alembic/versions/7a1abb918f48_initial_schema.py -----
"""initial schema

Revision ID: 7a1abb918f48
Revises: 1cb3e4a64fe7
Create Date: 2025-05-09 18:47:00.190129

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = '7a1abb918f48'
down_revision: Union[str, None] = '1cb3e4a64fe7'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('invoices',
    sa.Column('id', sa.String(), nullable=False),
    sa.Column('tenant_id', sa.String(), nullable=False),
    sa.Column('payment_hash', sa.String(), nullable=False),
    sa.Column('amount_msat', sa.Integer(), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('customer_name', sa.String(), nullable=True),
    sa.Column('status', sa.String(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=True),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('payment_hash')
    )
    op.create_table('receipts',
    sa.Column('id', sa.String(), nullable=False),
    sa.Column('invoice_id', sa.String(), nullable=False),
    sa.Column('pdf_url', sa.String(), nullable=True),
    sa.Column('signature', sa.String(), nullable=True),
    sa.Column('generated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['invoice_id'], ['invoices.id'], ),
    sa.PrimaryKeyConstraint('id')
    )
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_table('receipts')
    op.drop_table('invoices')
    # ### end Alembic commands ###


----- Fichero: ./alembic/versions/c07fcca22c82_initial_schema.py -----
"""initial schema

Revision ID: c07fcca22c82
Revises: 
Create Date: 2025-05-09 18:22:00.442848

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'c07fcca22c82'
down_revision: Union[str, None] = None
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    pass
    # ### end Alembic commands ###


----- Fichero: ./app/core/auth.py -----
# app/core/auth.py

from fastapi import Request, HTTPException
from fastapi.responses import JSONResponse
from sqlalchemy.orm import Session
from app.core.db import get_db
from app.models import APIKey

async def verify_api_key(request: Request, call_next):
    # Rutas p√∫blicas
    if request.url.path.startswith("/docs") or request.url.path.startswith("/openapi.json"):
        return await call_next(request)

    key = request.headers.get("x-api-key")
    if not key:
        return JSONResponse(status_code=401, content={"error": "Missing API Key"})

    # Obtener sesi√≥n de DB
    db: Session = next(get_db())
    api_key = (
        db.query(APIKey)
          .filter(APIKey.key_hash == key, APIKey.is_active.is_(True))
          .first()
    )
    db.close()

    if not api_key:
        return JSONResponse(status_code=401, content={"error": "Invalid API Key"})

    # inyectamos tenant_id en request.state para los endpoints
    request.state.tenant_id = api_key.tenant_id
    return await call_next(request)


def get_current_tenant(request: Request) -> str:
    return getattr(request.state, "tenant_id", None)


----- Fichero: ./app/core/config.py -----
from dotenv import load_dotenv
import os

def load_config():
    load_dotenv()


----- Fichero: ./app/core/db.py -----
# app/core/db.py

import os
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.ext.declarative import declarative_base

# Carga de la URL completa desde la variable de entorno
# Aseg√∫rate de tener en tu .env:
# DATABASE_URL=postgresql://usuario:password@host:puerto/base_de_datos
DATABASE_URL = os.getenv("DATABASE_URL")
if not DATABASE_URL:
    raise RuntimeError("La variable de entorno DATABASE_URL no est√° definida")

# Configuramos SQLAlchemy
engine = create_engine(DATABASE_URL, echo=False)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
Base = declarative_base()

def get_db():
    """Dependency de FastAPI para obtener una sesi√≥n de DB y luego cerrarla."""
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

def init_db():
    """Crea las tablas si no existen (√∫til en development)."""
    from app.models import Invoice, Receipt  # importa directamente tus modelos
    Base.metadata.create_all(bind=engine)


----- Fichero: ./app/core/__init__.py -----


----- Fichero: ./app/core/pdf_generator.py -----
# app/core/pdf_generator.py

import uuid
from pathlib import Path
from jinja2 import Environment, FileSystemLoader, select_autoescape
from weasyprint import HTML
from app.models import Invoice

# Definir ruta absoluta a la carpeta ra√≠z del proyecto
BASE_DIR = Path(__file__).resolve().parent.parent.parent
# Carpeta donde se guardan los recibos PDF
PDF_STORAGE_DIR = BASE_DIR / "generated_receipts"
PDF_STORAGE_DIR.mkdir(parents=True, exist_ok=True)

# Inicializar Jinja2 para cargar plantillas desde la carpeta `templates`
TEMPLATES_DIR = BASE_DIR / "templates"
# Aseg√∫rate de crear la carpeta `templates/` y un archivo `receipt.html`
env = Environment(
    loader=FileSystemLoader(str(TEMPLATES_DIR)),
    autoescape=select_autoescape(["html", "xml"])
)


def generate_pdf(invoice: Invoice) -> tuple[str, str]:
    """
    Genera un PDF real usando WeasyPrint a partir de una plantilla HTML.
    Devuelve:
      - La ruta ABSOLUTA al fichero PDF
      - Una firma simulada (uuid corto)
    """
    # Datos para la plantilla
    data = {
        "invoice_id": invoice.id,
        "cliente": invoice.customer_name or "N/A",
        "monto_msat": invoice.amount_msat,
        "descripcion": invoice.description,
        "payment_hash": invoice.payment_hash,
        "firma": str(uuid.uuid4())[:16]
    }

    # Cargar y renderizar la plantilla
    template = env.get_template("receipt.html")
    html_content = template.render(**data)

    # Generar nombre de archivo y ruta
    filename = f"{invoice.id}.pdf"
    pdf_path = PDF_STORAGE_DIR / filename

    # Usar WeasyPrint para escribir el PDF
    HTML(string=html_content).write_pdf(target=str(pdf_path))

    return str(pdf_path), data["firma"]


----- Fichero: ./app/__init__.py -----


----- Fichero: ./app/models.py -----
# app/models.py

import uuid
from datetime import datetime
from sqlalchemy import Column, String, Integer, DateTime, Boolean, ForeignKey, Text
from app.core.db import Base

def gen_id():
    return str(uuid.uuid4())

class Tenant(Base):
    __tablename__ = "tenants"
    id           = Column(String,   primary_key=True, default=gen_id)
    name         = Column(String,   nullable=False)
    email        = Column(String,   nullable=False, unique=True)
    plan         = Column(String,   nullable=False, default="free")  # free, monthly, yearly
    next_billing = Column(DateTime)
    is_active    = Column(Boolean,  default=True)
    created_at   = Column(DateTime, default=datetime.utcnow)

class APIKey(Base):
    __tablename__ = "api_keys"
    id         = Column(String,   primary_key=True, default=gen_id)
    tenant_id  = Column(String,   ForeignKey("tenants.id"), nullable=False)
    key_hash   = Column(String,   nullable=False, unique=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    expires_at = Column(DateTime)
    is_active  = Column(Boolean,  default=True)

class Invoice(Base):
    __tablename__ = "invoices"
    id            = Column(String,   primary_key=True, default=gen_id)
    tenant_id     = Column(String,   ForeignKey("tenants.id"), nullable=False)
    payment_hash  = Column(String,   unique=True,  nullable=False)
    amount_msat   = Column(Integer,  nullable=False)
    description   = Column(Text)
    customer_name = Column(String)
    status        = Column(String,   default="pending")  # paid, expired
    created_at    = Column(DateTime, default=datetime.utcnow)

class Receipt(Base):
    __tablename__ = "receipts"
    id           = Column(String,   primary_key=True, default=gen_id)
    invoice_id   = Column(String,   ForeignKey("invoices.id"), nullable=False)
    pdf_url      = Column(String)
    signature    = Column(String)
    generated_at = Column(DateTime, default=datetime.utcnow)


----- Fichero: ./app/routes/__init__.py -----


----- Fichero: ./app/routes/invoices.py -----
import logging
from fastapi import APIRouter, Depends, HTTPException, Request
from sqlalchemy.exc import IntegrityError
from sqlalchemy.orm import Session
from app.schemas import InvoiceCreate, InvoiceResponse
from app.models import Invoice, Receipt
from app.core.auth import get_current_tenant
from app.core.pdf_generator import generate_pdf
from app.core.db import get_db
from app.services.lnd_grpc import LndGrpcClient

# Configuramos logging
t_logger = logging.getLogger(__name__)
logging.basicConfig(level=logging.INFO)

router = APIRouter()
lnd = LndGrpcClient()

@router.post("/", response_model=InvoiceResponse, tags=["Invoices"])
def create_invoice(
    payload: InvoiceCreate,
    request: Request,
    db: Session = Depends(get_db),
    tenant_id: str = Depends(get_current_tenant)
):
    t_logger.info(f"‚Üí create_invoice payload recibido: {payload}")

    # 1) Comprobamos si ya existe invoice para este payment_hash + tenant
    existing = (
        db.query(Invoice)
          .filter(
              Invoice.payment_hash == payload.payment_hash,
              Invoice.tenant_id == tenant_id
          )
          .first()
    )
    if existing:
        t_logger.info(f"‚Ü™ Invoice existente encontrada: {existing.id}")
        # Verificar si ya existe un recibo asociado
        receipt = (
            db.query(Receipt)
              .filter(Receipt.invoice_id == existing.id)
              .first()
        )
        if receipt:
            return InvoiceResponse(
                invoice_id=existing.id,
                status=existing.status,
                receipt_id=receipt.id,
                receipt_url=receipt.pdf_url
            )
        # Si no hay recibo, generar ahora
        t_logger.info(f"‚öô Generando recibo para invoice existente {existing.id}")
        pdf_url, signature = generate_pdf(existing)
        receipt = Receipt(
            invoice_id=existing.id,
            pdf_url=pdf_url,
            signature=signature
        )
        db.add(receipt)
        db.commit()
        db.refresh(receipt)
        return InvoiceResponse(
            invoice_id=existing.id,
            status=existing.status,
            receipt_id=receipt.id,
            receipt_url=pdf_url
        )

    # 2) Verificamos en LND que el pago est√© confirmado usando gRPC
    if not lnd.check_payment(payload.payment_hash):
        t_logger.warning(f"Pago no confirmado para hash {payload.payment_hash}")
        raise HTTPException(status_code=400, detail="Pago no confirmado")

    # 3) Creamos la nueva invoice
    invoice = Invoice(
        tenant_id=tenant_id,
        payment_hash=payload.payment_hash,
        amount_msat=payload.amount_msat,
        description=payload.description,
        customer_name=payload.customer_name,
        status="paid"
    )
    db.add(invoice)
    try:
        db.commit()
    except IntegrityError:
        db.rollback()
        t_logger.error(f"Violaci√≥n de clave √∫nica: {payload.payment_hash}")
        raise HTTPException(status_code=409, detail="Invoice ya existe")
    db.refresh(invoice)
    t_logger.info(f"‚úî Invoice creada con id {invoice.id}")

    # 4) Generamos el PDF y la firma
    pdf_url, signature = generate_pdf(invoice)
    t_logger.info(f"‚úì PDF generado en {pdf_url}, firma={signature}")

    # 5) Guardamos el receipt
    receipt = Receipt(
        invoice_id=invoice.id,
        pdf_url=pdf_url,
        signature=signature
    )
    db.add(receipt)
    db.commit()
    db.refresh(receipt)
    t_logger.info(f"‚úî Receipt creado con id {receipt.id}")

    # 6) Devolvemos la respuesta final
    return InvoiceResponse(
        invoice_id=invoice.id,
        status=invoice.status,
        receipt_id=receipt.id,
        receipt_url=pdf_url
    )


----- Fichero: ./app/routes/receipts.py -----
# app/routes/receipts.py

from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Session
from fastapi.responses import FileResponse
from app.core.auth import get_current_tenant
from app.core.db import get_db
from app.models import Receipt, Invoice

router = APIRouter()

@router.get("/{receipt_id}", response_class=FileResponse, tags=["Receipts"])
def get_receipt(
    receipt_id: str,
    db: Session = Depends(get_db),
    tenant_id: str = Depends(get_current_tenant)
):
    """
    Devuelve el PDF de un recibo s√≥lo si pertenece al tenant autenticado.
    """
    # Buscamos el recibo asegurando que el invoice asociado pertenece al tenant
    receipt = (
        db.query(Receipt)
          .join(Invoice, Invoice.id == Receipt.invoice_id)
          .filter(Receipt.id == receipt_id,
                  Invoice.tenant_id == tenant_id)
          .first()
    )
    if not receipt:
        raise HTTPException(status_code=404, detail="Receipt not found")

    return FileResponse(
        path=receipt.pdf_url,
        media_type="application/pdf",
        filename=f"{receipt.id}.pdf"
    )


----- Fichero: ./app/schemas.py -----
from pydantic import BaseModel, Field
from typing import Optional
from datetime import datetime

class InvoiceCreate(BaseModel):
    payment_hash: str
    amount_msat: int
    description: str
    customer_name: Optional[str] = None

class InvoiceResponse(BaseModel):
    invoice_id: str
    status: str
    receipt_id: Optional[str] = None
    receipt_url: Optional[str] = None


----- Fichero: ./app/services/__init__.py -----


----- Fichero: ./app/services/lnd_grpc.py -----
import os
from dotenv import load_dotenv
from lndgrpc import LNDClient

load_dotenv()

macaroon_filepath = os.getenv("LND_MACAROON_PATH")
cert_filepath = os.getenv("LND_TLS_CERT_PATH")
grpc_host = os.getenv("LND_GRPC_HOST")

if not all([macaroon_filepath, cert_filepath, grpc_host]):
    raise RuntimeError("Faltan variables de entorno requeridas")

class LndGrpcClient:
    def __init__(self, ip_address=None, network=None, macaroon_path=None, cert_path=None):
        self.client = LNDClient(
            ip_address=ip_address or os.getenv("LND_GRPC_HOST", "127.0.0.1:10009"),
            network=network or os.getenv("LND_NETWORK", "regtest"),
            macaroon_filepath=macaroon_path or os.getenv("LND_MACAROON_PATH"),
            cert_filepath=cert_path or os.getenv("LND_TLS_CERT_PATH"),
            admin=True
        )

    def add_invoice(self, amount_sat: int, memo: str = ""):
        response = self.client.add_invoice(value=amount_sat, memo=memo)
        return {
            "r_hash": response.r_hash.hex(),
            "payment_request": response.payment_request,
        }

    def lookup_invoice(self, r_hash_hex: str):
        invoice = self.client.lookup_invoice(r_hash_str=r_hash_hex)
        return {
            "settled": invoice.settled,
            "memo": invoice.memo,
            "amt_paid_sat": invoice.amt_paid_sat,
        }

    def check_payment(self, payment_hash_hex: str) -> bool:
        try:
            invoice = self.client.lookup_invoice(r_hash_str=payment_hash_hex)
            return invoice.settled
        except Exception as e:
            print(f"[‚ùå] Error al verificar invoice: {e}")
            return False


----- Fichero: ./app/services/stripe.py -----


----- Fichero: ./docker-compose.yml -----


----- Fichero: ./docker/lnd/docker-compose.yml -----
version: "3.9"

services:
  bitcoind:
    image: bitcoin/bitcoin:latest
    container_name: bitcoind
    command: >
      bitcoind
      -regtest=1
      -server=1
      -printtoconsole
      -rpcallowip=0.0.0.0/0
      -rpcbind=0.0.0.0
      -rpcuser=bitcoin
      -rpcpassword=bitcoin
      -txindex=1
      -fallbackfee=0.0002
      -zmqpubrawblock=tcp://0.0.0.0:28332
      -zmqpubrawtx=tcp://0.0.0.0:28333
    ports:
      - "18443:18443"
    volumes:
      - bitcoind_data:/bitcoin
    networks:
      - lnnet
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-regtest", "-rpcuser=bitcoin", "-rpcpassword=bitcoin", "getblockchaininfo"]
      interval: 5s
      timeout: 5s
      retries: 10

  lnd1:
    image: lightninglabs/lnd:v0.18.5-beta
    container_name: lnd1
    command: >
      lnd
      --noseedbackup
      --alias=lnd1
      --bitcoin.active
      --bitcoin.regtest
      --bitcoin.node=bitcoind
      --bitcoind.rpchost=bitcoind:18443
      --bitcoind.rpcuser=bitcoin
      --bitcoind.rpcpass=bitcoin
      --bitcoind.zmqpubrawblock=tcp://bitcoind:28332
      --bitcoind.zmqpubrawtx=tcp://bitcoind:28333
      --tlsextraip=0.0.0.0
      --rpclisten=0.0.0.0:10009
      --restlisten=0.0.0.0:8080
      --listen=0.0.0.0:9735
      --debuglevel=info
    ports:
      - "8080:8080"
      - "10009:10009"
      - "9735:9735"
    volumes:
      - ./lnd1-data:/root/.lnd
    depends_on:
      bitcoind:
        condition: service_healthy
    networks:
      - lnnet

  lnd2:
    image: lightninglabs/lnd:v0.18.5-beta
    container_name: lnd2
    environment:
      - GRPC_SERVER=localhost:10010
    command: >
      lnd
      --noseedbackup
      --alias=lnd2
      --bitcoin.active
      --bitcoin.regtest
      --bitcoin.node=bitcoind
      --bitcoind.rpchost=bitcoind:18443
      --bitcoind.rpcuser=bitcoin
      --bitcoind.rpcpass=bitcoin
      --bitcoind.zmqpubrawblock=tcp://bitcoind:28332
      --bitcoind.zmqpubrawtx=tcp://bitcoind:28333
      --tlsextraip=0.0.0.0
      --rpclisten=0.0.0.0:10010
      --restlisten=0.0.0.0:8081
      --listen=0.0.0.0:9736
      --debuglevel=info
    ports:
      - "8081:8081"
      - "10010:10010"
      - "9736:9736"
    volumes:
      - ./lnd2-data:/root/.lnd
    depends_on:
      bitcoind:
        condition: service_healthy
    networks:
      - lnnet

volumes:
  bitcoind_data:
  lnd2_data:

networks:
  lnnet:
    driver: bridge


----- Fichero: ./docs/openapi/openapi.yml -----
openapi: 3.0.3
info:
  title: Lightpen API
  version: "1.0"
  description: API para registrar pagos en la red Lightning y generar recibos PDF firmados digitalmente.
servers:
  - url: http://localhost:8000
    description: Servidor local de desarrollo
paths:
  /invoices/:
    post:
      summary: Crear o recuperar una factura
      description: Verifica un pago por `payment_hash`, genera una factura si no existe y crea un recibo en PDF si el pago fue confirmado.
      tags:
        - Invoices
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/InvoiceCreate"
      responses:
        '200':
          description: Factura registrada o recibo generado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/InvoiceResponse"
        '400':
          description: Pago no confirmado
        '409':
          description: Conflicto - La factura ya existe
  /receipts/{receipt_id}:
    get:
      summary: Descargar recibo en PDF
      description: Devuelve el archivo PDF de un recibo asociado a una invoice confirmada, siempre que el tenant sea el due√±o.
      tags:
        - Receipts
      security:
        - ApiKeyAuth: []
      parameters:
        - name: receipt_id
          in: path
          required: true
          schema:
            type: string
          description: ID del recibo (UUID)
      responses:
        '200':
          description: PDF del recibo
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        '404':
          description: Recibo no encontrado o acceso denegado
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key
  schemas:
    InvoiceCreate:
      type: object
      required:
        - payment_hash
        - amount_msat
        - description
      properties:
        payment_hash:
          type: string
          example: "637d0021c9a611c873a209db3e549705875deea9bc1f16ac812dfea7790582cb"
        amount_msat:
          type: integer
          example: 500000
        description:
          type: string
          example: "Servicio de consultor√≠a"
        customer_name:
          type: string
          example: "Juan P√©rez"
    InvoiceResponse:
      type: object
      required:
        - invoice_id
        - status
      properties:
        invoice_id:
          type: string
          example: "54ad320e-2c77-4c9e-8b3d-c7f4f383dfe7"
        status:
          type: string
          enum: [pending, paid, expired]
          example: "paid"
        receipt_id:
          type: string
          nullable: true
          example: "b2a0121b-c458-4905-a7db-01221d865e56"
        receipt_url:
          type: string
          nullable: true
          example: "/generated_receipts/b2a0121b-c458-4905-a7db-01221d865e56.pdf"


----- Fichero: ./.env -----
DATABASE_URL=postgresql://myuser:mypassword@127.0.0.1:5432/lightning_receipts
STRIPE_SECRET_KEY=sk_test_yourkey
STRIPE_WEBHOOK_SECRET=whsec_yoursecret
API_KEY_SALT=change_this_salt

LND_DIR=./docker/lnd/lnd1-data
LND_TLS_CERT=./docker/lnd/lnd1-data/tls.cert
LND_MACAROON=./docker/lnd/lnd1-data/data/chain/bitcoin/regtest/admin.macaroon

LND2_GRPC_HOST=localhost:10010
LND2_REST_HOST=localhost:8081
LND2_TLS_CERT_PATH=./docker/lnd/lnd2-data/tls.cert
LND2_MACAROON_PATH=./docker/lnd/lnd2-data/data/chain/bitcoin/regtest/admin.macaroon

LND_GRPC_HOST=localhost:10009
LND_TLS_CERT_PATH=./docker/lnd/lnd1-data/tls.cert
LND_MACAROON_PATH=./docker/lnd/lnd1-data/data/chain/bitcoin/regtest/admin.macaroon
LND_NETWORK=regtest



----- Fichero: ./init_lightning_stack.py -----
import os
import time
import subprocess
import requests
from pathlib import Path
from dotenv import load_dotenv

# === Cargar configuraci√≥n desde .env
print("\U0001F527 Cargando variables desde .env...")
load_dotenv()

BITCOIN_RPC_USER = os.getenv("BITCOIN_RPC_USER", "bitcoin")
BITCOIN_RPC_PASSWORD = os.getenv("BITCOIN_RPC_PASSWORD", "bitcoin")
BITCOIN_CONTAINER = os.getenv("BITCOIN_CONTAINER", "bitcoind")
WALLET_NAME = os.getenv("BITCOIN_WALLET_NAME", "testwallet")
BITCOIN_CLI_BASE = f"docker exec {BITCOIN_CONTAINER} bitcoin-cli -regtest -rpcuser={BITCOIN_RPC_USER} -rpcpassword={BITCOIN_RPC_PASSWORD}"
BITCOIN_CLI = f"{BITCOIN_CLI_BASE} -rpcwallet={WALLET_NAME}"

LND_REST_HOST = os.getenv("LND_REST_HOST", "localhost:8080")
TLS_CERT = os.getenv("LND_TLS_CERT_PATH")
MACAROON_PATH = os.getenv("LND_MACAROON_PATH")
BASE_URL = f"https://{LND_REST_HOST}"

print(f"\U0001F50E LND_REST_HOST={LND_REST_HOST}")
print(f"\U0001F50E TLS_CERT={TLS_CERT}")
print(f"\U0001F50E MACAROON_PATH={MACAROON_PATH}")

SYNC_TIMEOUT = int(os.getenv("SYNC_TIMEOUT", 120))


def run(cmd):
    print(f"\U0001F680 Ejecutando: {cmd}")
    return subprocess.check_output(cmd, shell=True).decode().strip()

def load_macaroon_hex(path: str) -> str:
    if not Path(path).exists():
        raise FileNotFoundError(f"‚ùå Macaroon no encontrado: {path}")
    with open(path, "rb") as f:
        return f.read().hex()

MACAROON_HEADER = {"Grpc-Metadata-macaroon": load_macaroon_hex(MACAROON_PATH)}

# === BITCOIND ===

def bitcoind_available():
    try:
        run(f"{BITCOIN_CLI_BASE} getblockchaininfo")
        return True
    except Exception as e:
        print(f"‚ùå Error al acceder a bitcoind: {e}")
        return False

def ensure_wallet_loaded():
    print("\U0001F50E Verificando wallet en bitcoind...")
    wallets = run(f"{BITCOIN_CLI_BASE} listwallets")
    if WALLET_NAME in wallets:
        print(f"\U0001F4BC Wallet '{WALLET_NAME}' ya est√° cargado.")
        return
    print(f"üß∞ Creando wallet '{WALLET_NAME}'...")
    run(f"{BITCOIN_CLI_BASE} createwallet {WALLET_NAME}")
    print("‚úÖ Wallet creado y cargado.")

def get_block_count():
    return int(run(f"{BITCOIN_CLI} getblockcount"))

def mine_blocks_if_needed(target_blocks=101):
    current = get_block_count()
    if current >= target_blocks:
        print(f"üü¢ Bitcoin ya tiene {current} bloques")
        return
    print(f"‚õèÔ∏è Minando {target_blocks - current} bloques...")
    address = run(f"{BITCOIN_CLI} getnewaddress")
    run(f"{BITCOIN_CLI} generatetoaddress {target_blocks - current} {address}")
    print("‚úÖ Miner√≠a completa")

# === LND ===

def check_lnd_ready():
    try:
        r = requests.get(f"{BASE_URL}/v1/getinfo", verify=TLS_CERT, headers=MACAROON_HEADER)
        return r.status_code == 200
    except requests.exceptions.RequestException as e:
        print(f"‚ùå Error al conectar con lnd1: {e}")
    return False

def check_wallet_locked():
    try:
        r = requests.get(f"{BASE_URL}/v1/wallet/seed", verify=TLS_CERT)
        return r.status_code == 403
    except:
        return False

def unlock_wallet():
    print("üîì Desbloqueando wallet...")
    payload = {"wallet_password": "cGFzc3dvcmQ="}  # "password"
    r = requests.post(f"{BASE_URL}/v1/unlockwallet", json=payload, verify=TLS_CERT)
    r.raise_for_status()
    print("‚úÖ Wallet desbloqueado")

def wait_for_lnd_sync(rest_host, tls_cert_path, macaroon_path, timeout):
    print(f"‚è≥ Esperando que {rest_host} se sincronice con la cadena...")
    headers = {"Grpc-Metadata-macaroon": load_macaroon_hex(macaroon_path)}
    for _ in range(timeout):
        try:
            r = requests.get(f"https://{rest_host}/v1/getinfo", headers=headers, verify=tls_cert_path)
            if r.status_code == 200:
                info = r.json()
                print(f"üìä getinfo: {info}")
                if info.get("synced_to_chain"):
                    print("‚úÖ Nodo sincronizado con la cadena")
                    return True
        except requests.RequestException:
            pass
        time.sleep(1)
    print(f"‚ùå Timeout: {rest_host} no se sincroniz√≥ con la cadena en {timeout} segundos.")
    return False

def fund_lnd_node(rest_host, tls_cert_path, macaroon_path, amount_btc=1):
    print(f"üí∏ Fondeando nodo en {rest_host} con {amount_btc} BTC...")
    headers = {"Grpc-Metadata-macaroon": load_macaroon_hex(macaroon_path)}
    try:
        r = requests.get(f"https://{rest_host}/v1/newaddress?type=0", headers=headers, verify=tls_cert_path)
        r.raise_for_status()
        address = r.json()["address"]
        print(f"üè¶ Enviando {amount_btc} BTC a {address}")
        run(f"{BITCOIN_CLI} sendtoaddress {address} {amount_btc}")
        mine_blocks_if_needed(get_block_count() + 6)
        print("‚úÖ Fondeo y confirmaci√≥n completa")
    except Exception as e:
        print(f"‚ö†Ô∏è No se pudo fondear {rest_host}: {e}")

# === MAIN ===

if __name__ == "__main__":
    print("\U0001F50D Esperando que bitcoind est√© accesible...")
    for _ in range(10):
        if bitcoind_available():
            break
        time.sleep(2)
    else:
        print("‚ùå No se pudo conectar a bitcoind")
        exit(1)

    ensure_wallet_loaded()
    mine_blocks_if_needed(101)

    print("\U0001F50D Verificando estado de lnd1...")
    for _ in range(10):
        if Path(TLS_CERT).exists() and Path(MACAROON_PATH).exists():
            break
        print("‚è≥ Esperando archivos TLS/Macaroon...")
        time.sleep(2)
    else:
        print("‚ùå No se encontraron archivos TLS o macaroon.")
        exit(1)

    for _ in range(10):
        if check_lnd_ready():
            print("üü¢ lnd1 ya est√° desbloqueado y listo.")
            fund_lnd_node(LND_REST_HOST, TLS_CERT, MACAROON_PATH)
            break
        elif check_wallet_locked():
            print("üîê Wallet bloqueado. Intentando desbloquear...")
            try:
                unlock_wallet()
                fund_lnd_node(LND_REST_HOST, TLS_CERT, MACAROON_PATH)
                break
            except Exception as e:
                print(f"‚ùå Error al desbloquear wallet: {e}")
                exit(1)
        else:
            print("üìÖ El nodo no responde como bloqueado ni inicializado. Verific√° manualmente.")
            exit(1)

    LND2_REST = os.getenv("LND2_REST_HOST")
    LND2_CERT = os.getenv("LND2_TLS_CERT_PATH")
    LND2_MACAROON = os.getenv("LND2_MACAROON_PATH")

    print(f"\U0001F50E LND2_REST_HOST={LND2_REST}")
    print(f"\U0001F50E LND2_TLS_CERT_PATH={LND2_CERT}")
    print(f"\U0001F50E LND2_MACAROON_PATH={LND2_MACAROON}")

    if LND2_REST and Path(LND2_CERT).exists() and Path(LND2_MACAROON).exists():
        fund_lnd_node(LND2_REST, LND2_CERT, LND2_MACAROON)
        try:
            info = requests.get(f"https://{LND_REST_HOST}/v1/getinfo", headers=MACAROON_HEADER, verify=TLS_CERT).json()
            pubkey = info["identity_pubkey"]
            if wait_for_lnd_sync(LND2_REST, LND2_CERT, LND2_MACAROON, SYNC_TIMEOUT):
                print("‚úÖ LND2 sincronizado y listo para conexi√≥n y canal (continuar l√≥gica aqu√≠)")
            else:
                print("‚ö†Ô∏è Saltando conexi√≥n y apertura de canal: lnd2 no est√° sincronizado")
        except Exception as e:
            print(f"‚ö†Ô∏è No se pudo obtener informaci√≥n de lnd1 para abrir canal: {e}")
    else:
        print("‚ÑπÔ∏è Saltando fondeo de lnd2: configuraci√≥n incompleta")


----- Fichero: ./lightpen_test_log.txt -----
[2025-05-15T16:15:12.162366] Esperando disponibilidad de Lightpen
[2025-05-15T16:15:12.169195] Lightpen responde correctamente
[2025-05-15T16:15:12.174878] Invoice creada: payment_request=lnbcrt5u1p5zvycspp5vd7sqgwf5cgusuazp8dnu4yhqkr4mm4fhs03dtyp9hl2w7g9st9sdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5jl4zmv8r0hrw92l8eaz8zs2kl834whql8haq627dnnlv7qwellaq9qxpqysgqhdrkltzfc53kyakkdfhcrncy2y8e8rycttvezeadpefgksdsn7m5aaevcm7g8tdqp6qvc882s7k6rf6g4ze9uy6kfltsxz7gcw3d4zcpnewfq2 | r_hash=Y30AIcmmEchzognbPlSXBYdd7qm8HxasgS3+p3kFgss=
[2025-05-15T16:15:12.175075] Valores de payment_hash - HEX: 637d0021c9a611c873a209db3e549705875deea9bc1f16ac812dfea7790582cb | B64: Y30AIcmmEchzognbPlSXBYdd7qm8HxasgS3+p3kFgss=
[2025-05-15T16:15:12.328298] Pago enviado desde lnd2: payment_error= | status=ok
[2025-05-15T16:15:12.335758] Consulta estado de invoice (637d0021c9a611c873a209db3e549705875deea9bc1f16ac812dfea7790582cb): settled=True
[2025-05-15T16:15:12.335900] Invoice settled detectado en intento 1
[2025-05-15T16:15:14.352163] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:15:14.352254] Intento 1: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:15:14.864537] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:15:14.864627] Intento 2: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:15:15.877983] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:15:15.878111] Intento 3: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:15:17.894879] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:15:17.894974] Intento 4: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:15:21.908185] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:15:21.908293] Intento 5: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:15:26.920654] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:15:26.922310] Intento 6: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:15:31.937356] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:15:31.937515] Intento 7: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:15:36.953817] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:15:36.953969] Intento 8: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:15:41.969647] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:15:41.969746] Intento 9: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:15:46.983315] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:15:46.983419] Intento 10: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:15:51.984039] Lightpen no reconoci√≥ el pago a tiempo
[2025-05-15T16:16:38.316856] Esperando disponibilidad de Lightpen
[2025-05-15T16:16:38.322017] Lightpen responde correctamente
[2025-05-15T16:16:38.328682] Invoice creada: payment_request=lnbcrt5u1p5zvymxpp5nmrp8v6lslpt7flpgd0df9thqkny6zsqex8xhtyvmg44gvthwycqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp572zr3htjj730hpw6zlvdfr4s55vsn4wlx602fn6vm9xkw2erq39q9qxpqysgqv384g3hs9uvvtfase044zvtdj4nsllkksjgweqddzkklv9mzyq4sjkp59fw4282cntwtaqmtgyqxp87qkcl35jjs92vuew4hygey3lsplc6fm9 | r_hash=nsYTs1+Hwr8n4UNe1JV3BaZNCgDJjmusjNorVDF3cTA=
[2025-05-15T16:16:38.328990] Valores de payment_hash - HEX: 9ec613b35f87c2bf27e1435ed4957705a64d0a00c98e6bac8cda2b5431777130 | B64: nsYTs1+Hwr8n4UNe1JV3BaZNCgDJjmusjNorVDF3cTA=
[2025-05-15T16:16:38.474953] Pago enviado desde lnd2: payment_error= | status=ok
[2025-05-15T16:16:38.480715] Consulta estado de invoice (9ec613b35f87c2bf27e1435ed4957705a64d0a00c98e6bac8cda2b5431777130): settled=True
[2025-05-15T16:16:38.480852] Invoice settled detectado en intento 1
[2025-05-15T16:16:40.494286] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:16:40.494384] Intento 1: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:16:41.007532] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:16:41.007617] Intento 2: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:16:42.018436] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:16:42.018522] Intento 3: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:16:44.027967] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:16:44.028047] Intento 4: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:16:48.041827] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:16:48.041952] Intento 5: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:16:53.056086] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:16:53.056192] Intento 6: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:16:58.069178] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:16:58.069281] Intento 7: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:17:03.081488] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:17:03.081647] Intento 8: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:17:08.094094] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:17:08.094202] Intento 9: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:17:13.105828] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:17:13.105910] Intento 10: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:17:18.106252] Lightpen no reconoci√≥ el pago a tiempo
[2025-05-15T16:20:43.100659] Esperando disponibilidad de Lightpen
[2025-05-15T16:20:43.108376] Lightpen responde correctamente
[2025-05-15T16:20:43.230094] Comando docker exec exitoso: docker exec lnd1 lncli --network=regtest listinvoices
{
    "invoices":  [
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "8f84379c6ca140edc1a9e72be87c8f57af7cae5ffba449b2136d96d030736d06",
            "r_hash":  "1b0df29ce45c15e7d639d3364937c1893d6101b669315e10803cc0bd84e4bad4",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747317635",
            "settle_date":  "1747317635",
            "payment_request":  "lnbcrt5u1p5ztuurpp5rvxl988yts27043e6vmyjd7p3y7kzqdkdyc4uyyq8nqtmp8yht2qdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5xjat6s5q4l7h4g0l7ttezkyngw8558pasnd54cdj6y06uctadcts9qxpqysgqc4z4alw6l22atu4f4wtufjx2jqpvhhmrwzwghve7u46tn3jzdaesrd09mycxd8dngp6luwssscq622luh6pxagsh73d37w3lkatnvecqklcus7",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "1",
            "settle_index":  "1",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "0",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747317635",
                    "resolve_time":  "1747317635",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "34babd4280affd7aa1fff2d7915893438f4a1c3d84db4ae1b2d11fae617d6e17",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "4a4cd561fbf973cd4e81aac5e8bc06985c20ac1db55019d2deab9f251fbd837d",
            "r_hash":  "161b58efa16f39c6aa9e742be3bd162f19a29b64659c6eb96cd64db5b43e4c60",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747317761",
            "settle_date":  "1747317761",
            "payment_request":  "lnbcrt5u1p5ztaqppp5zcd43mapduuud257ws4780gk9uv69xmyvkwxawtv6exmtdp7f3sqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5pfszjshsj0lhxfe6s06tmhcvgtxmmul9s34jje0nz37qppfmh0es9qxpqysgqkg2vedcy6uqptwu400muvdk9yll7efchv9rlsaart70d8phjj8yqt45kmzug5lkxype8ksm60prz3wc9vdh0yw4ce809tmgjddzaawcpmy6r90",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "2",
            "settle_index":  "2",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "1",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747317761",
                    "resolve_time":  "1747317761",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "0a602942f093ff73273a83f4bddf0c42cdbdf3e5846b2965f3147c00853bbbf3",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "f5d3298ea64e81b5baf8e451cdafe141d1b23c5d2b5b1c82d55fd0284c18e848",
            "r_hash":  "01234ec81f4291abf8337067d6bfe98cdb054ffe47cb2931905a191613494d2a",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747318394",
            "settle_date":  "1747318395",
            "payment_request":  "lnbcrt5u1p5ztan6pp5qy35ajqlg2g6h7pnwpnad0lf3nds2nl7gl9jjvvstgv3vy6ff54qdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5da6ens4z4gxcdd58faggvph0hdn5m4l2xflr2dldsua7slxm4hcs9qxpqysgqt0w2g5azqzlefg8379kh5vw5sxtpfjsmaghwuhqvywk5cg774yrphrwq32sjzmzal2gqgn3mmfu0tdpszlgaj878zj3u9sj60y5wshcppqpy3v",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "3",
            "settle_index":  "3",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "2",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747318395",
                    "resolve_time":  "1747318395",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "6f7599c2a2aa0d86b6874f508606efbb674dd7ea327e3537ed873be87cdbadf1",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "0a0acc3fdca1fccded129297dae2c9aa4905b4f12066e6d592186e70c1f9587c",
            "r_hash":  "2e8c2d47bcb0ab7867b8907a47b716800f1c0390d21f4712b4b6ce3e1c2f5a63",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747318694",
            "settle_date":  "1747318694",
            "payment_request":  "lnbcrt5u1p5ztaaxpp596xz63aukz4hseacjpay0dcksq83cqus6g05wy45km8ru8p0tf3sdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5quv9fku5ljw9w3qetzh6unq4r5v66vh8w3pp0llyjd2tkpv74tgs9qxpqysgqgpkth5mj03lgrtxt38t345wqx378dw7t5xnldgdylgk73mlsnhwsxunehy5nr7d04sve9qerhv4kq7jv2xnmu0kkll955gq2ssagcuqpke5cw4",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "4",
            "settle_index":  "4",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "3",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747318694",
                    "resolve_time":  "1747318694",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "071854db94fc9c57441958afae4c151d19ad32e7744217ffe49354bb059eaad1",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "7500e2117c74cd20e63cb0645897d6365ecea744dfb3ef778ccb72245eec0a2f",
            "r_hash":  "19e185e45f955e470e155f9986123dba0fdf3b54fc8b91ec29beadb8ab832fc0",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747319060",
            "settle_date":  "1747319060",
            "payment_request":  "lnbcrt5u1p5zt7g5pp5r8sctezlj40ywrs4t7vcvy3ahg8a7w65lj9ermpfh6km32ur9lqqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5wf6g0zhhzyt5uw8uamgj8gtruw55y9ek7wjwzcpencrgeaqqduws9qxpqysgqenu93zpax3t55ke8qucx2f939t2d9jddmv6xxhyx8p78g272lcxk7jhuxw4txgy8cq8nr7n8nwcmhdmu74cjs4y2hejzze497ewrunsq42egmf",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "5",
            "settle_index":  "5",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "4",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747319060",
                    "resolve_time":  "1747319060",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "7274878af711174e38fceed123a163e3a9421736f3a4e160399e068cf4006f1d",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "1360d67c38434195ee5785eeb3d877db6404ab0d68a86158a3b4f5cd8ac3ed24",
            "r_hash":  "10d34eb659b85c1137abb3920ca22ac7be0ee5017b83958f4b9571471d7f83cf",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747319210",
            "settle_date":  "1747319210",
            "payment_request":  "lnbcrt5u1p5zt7d2pp5zrf5adjehpwpzdatkwfqeg32c7lqaegp0wpetr6tj4c5w8tls08sdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5gw5g3t6k0xya9dtjtm7re7t9w726k2zgrn7wgz08n0r9el2z6sls9qxpqysgq4wwkkgc7nsdjjvdcgtd93fzcpg9vxmukmuth9vhw7ffuzxcvsyfzceltl2ha40mavfhq9q863kw5ylvzqykyapd54h2g5h0tfs447fgp7pw2g2",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "6",
            "settle_index":  "6",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "5",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747319210",
                    "resolve_time":  "1747319210",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "43a888af567989d2b5725efc3cf9657795ab28481cfce409e79bc65cfd42d43f",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "ce8c60ff743e5ffa27b82eddd0818af2598209a610336b22fc682d11b7467c70",
            "r_hash":  "176c11d38d79c92981b2c7b86ea67153da3c47bfc5f5ec50c470e1617af4d477",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747319241",
            "settle_date":  "1747319241",
            "payment_request":  "lnbcrt5u1p5zt7wfpp5zakpr5ud08yjnqdjc7uxafn320drc3alch67c5xywrskz7h563msdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5y0kyjwq297qt7p9yzxf2c3p4yfv2vh9ku5h0r42nvvyjx4dftees9qxpqysgqw0x5z4qw3mys5x4yjtpmh0e2929cushc74z5pez588p4qhygewdynmup09f623jga3j0qwhwjelkqwt8xr2k5de7u7sfg657e6s9htgqyvxarg",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "7",
            "settle_index":  "7",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "6",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747319241",
                    "resolve_time":  "1747319241",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "23ec49380a2f80bf04a41192ac44352258a65cb6e52ef1d55363092355a95e73",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "009b7ed64c13ae326a69916ac8b3ea23218b805e87ae84eaca1a4e2c454c1f27",
            "r_hash":  "cc7203e1cc3215b5961b6d21d0d51af17ce4399d97e16214c194aab4dc00b14c",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747319259",
            "settle_date":  "1747319260",
            "payment_request":  "lnbcrt5u1p5zt7wmpp5e3eq8cwvxg2mt9smd5sap4g6797wgwvajlsky9xpjj4tfhqqk9xqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5v5ea40negl3m24wnuaqgpcgnph8udctexpzv65vr2uuj8ng9z0ks9qxpqysgq9qjdjyezyss6n7y6dc9prq34k2fezcfrdlg0wdts9wp7ayall6syq5k53a50yl0xmk4n63spc2hmj9q598s2d8avwvkztysdvda3v4sp24lsm0",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "8",
            "settle_index":  "8",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "7",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747319260",
                    "resolve_time":  "1747319260",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "6533dabe7947e3b555d3e74080e1130dcfc6e1793044cd5183573923cd0513ed",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "323d9bd5926939b9b3fc04e2d855f5ca3a08a4219b968f3af836f6146e96f3ec",
            "r_hash":  "c38d830b78391d8b6c7ef8c211f07f0a32e0c904c5055c53751247a1273fa56e",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747319547",
            "settle_date":  "1747319547",
            "payment_request":  "lnbcrt5u1p5zt7hmpp5cwxcxzmc8ywckmr7lrpprurlpgewpjgyc5z4c5m4zfr6zfel54hqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5da457nsztgwtpzds7u4qvkl9xdqmcxv9t5fahmdxsqcfp5zmf6uq9qxpqysgqze03rckswhztw5cwk2q6tz2e7uec4syf4c87yayxrv8grgmezffrwdwg64tk5gmwvrhn4wwaye8eu0r0wkw5vn9q7hzfnju88agpskcpk7che5",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "9",
            "settle_index":  "9",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "8",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747319547",
                    "resolve_time":  "1747319547",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "6f6b4f4e025a1cb089b0f72a065be53341bc19855d13dbeda6803090d05b4eb8",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "777bfdf45c45fa0c4737e1720b0e90784fcca10c6d39dcfc18d4ba7583375b92",
            "r_hash":  "bdb5dbb8c70ea0f6805433e30265969d915c5dc3a685539fd33cdc7f5d1bb31f",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747319731",
            "settle_date":  "1747319731",
            "payment_request":  "lnbcrt5u1p5zt7anpp5hk6ahwx8p6s0dqz5x03syevknkg4chwr56z4887n8nw87hgmkv0sdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5q04435l0fjz9c0e4xtunuup7fufsuljg4kl2hjvmqztkd8yfxtvs9qxpqysgqvz4sawgv9lhutyerlt8zvmgrmjr0c6fx0lwhsq23as5hqe7wzgl8sc4s6n3uuw52uazj60v8gxmwtpshdm0hnlhf4v8fnkcj3vg7lrgpew3jsv",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "10",
            "settle_index":  "10",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "9",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747319731",
                    "resolve_time":  "1747319731",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "03eb58d3ef4c845c3f3532f93e703e4f130e7e48adbeabc99b0097669c8932d9",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "fa924e11c6454a05b2943b0b50dcd7552199b6cf485cddb58bcd6e8687e97099",
            "r_hash":  "a21a487ad6d86381b830fd93b873f8d79e9aea0ec9b72c5b99828ab090f94f59",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747320256",
            "settle_date":  "1747320256",
            "payment_request":  "lnbcrt5u1p5ztlwqpp55gdys7kkmp3crwpslkfmsulc670f46swexmjckues29tpy8efavsdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp50efl65mfatwykra5geea5ecekeq480sjksx6wq685q32tx7ntnhq9qxpqysgqc207xhpsuwxxv9nc2cn3xwz6hmlmjgpd5mwzepy4t7peyaynxyhpzqswyf32easd7vl6z9v7e6c9agegar4j9lr9l854nusuh54f9zgq9ce97e",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "11",
            "settle_index":  "11",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "10",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747320256",
                    "resolve_time":  "1747320256",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "7e53fd5369eadc4b0fb44673da6719b64153be12b40da70347a022a59bd35cee",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "af309441b38bce7e21440567d2789012d9a3c71045c4c2f3faa58c9ad82f8b9d",
            "r_hash":  "7e593801d5f9613d42fba56452be9270c60646239e65eaf606448c5a6857a2e1",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747320477",
            "settle_date":  "1747320477",
            "payment_request":  "lnbcrt5u1p5ztl5app50evnsqw4l9sn6shm54j9905jwrrqv33rnej74asxgjx956zh5tssdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp56nmt455rwl76kwl86y0g4ms3a89zjla4r9em7fllfqjucr938hvs9qxpqysgqjn5twas5t6648ujpfl2np6ykrs5ursu9sk92e377sej7y0703ztpa7wg05ddxq87wnsxlzy2wcenrfyf9jdnnq0s9uuyfx6mqkprlqcqe542ls",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "12",
            "settle_index":  "12",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "11",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747320477",
                    "resolve_time":  "1747320477",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "d4f6bad28377fdab3be7d11e8aee11e9ca297fb51973bf27ff4825cc0cb13dd9",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "2374d5d497d6acc4020ec8249638c9e4d1ed90eb1cb7c878f6312eee7f1d0cd3",
            "r_hash":  "11b47716db6f242030f3f13fb077b45ea7f48a5b8bc680eeff49901bdbbaca3b",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747320536",
            "settle_date":  "1747320536",
            "payment_request":  "lnbcrt5u1p5ztlkcpp5zx68w9kmdujzqv8n7ylmqaa5t6nlfzjm30rgpmhlfxgphka6egasdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp533k94cuh5mgrzsmhvdka3ewa7rhcy00cgkvtxce6ddnzllhf5szq9qxpqysgq8l6mt4eyc95klagkn26wychvkgx4f2knf3jnszzjv4kv4p3z536r7jvnye2f8w763ukqdjd3mylcl7uymt2fjlx4e6xlyugpepqys8gpn7hdlj",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "13",
            "settle_index":  "13",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "12",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747320536",
                    "resolve_time":  "1747320536",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "8c6c5ae397a6d0314377636dd8e5ddf0ef823df84598b3633a6b662ffee9a404",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "fdde12de314aa1a7489d6a037dab4e6cc74420496251acbe7d72446d0a06e9d9",
            "r_hash":  "3c76af6357bc4f44a91dc900579deea83b4c5847da868e7277bfa3dd1392c2a2",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747320652",
            "settle_date":  "1747320652",
            "payment_request":  "lnbcrt5u1p5ztl6vpp583m27c6hh385f2gaeyq9080w4qa5ckz8m2rguunhh73a6yujc23qdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5zjm904mf4xxp08s6ltxkml2dtmqhrhcjsxf08xudf5dvkwvgnckq9qxpqysgqwewutdmg2z5adu9jp0furasxjuw3h8jxzw0jugxlt4wedwm8dmnjss02tpas8598yc0rde988yneswpqhuuk9lmkn02lapm7xtp43kcp68jxh5",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "14",
            "settle_index":  "14",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "13",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747320652",
                    "resolve_time":  "1747320652",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "14b657d769a98c179e1afacd6dfd4d5ec171df128192f39b8d4d1acb39889e2c",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "bb3e8e171a7111e134aa41c8ff2867b9949d0834acf6667c8e18057097ecd303",
            "r_hash":  "61ead95f2da4b01cfd5553269b911b962223be538fac5d5c53a7388cdc8015b8",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747320671",
            "settle_date":  "1747320671",
            "payment_request":  "lnbcrt5u1p5ztl6lpp5v84djhed5jcpel242vnfhygmjc3z80jn37k96hzn5uugehyqzkuqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5uhywawhde870d4a4hcacuefsfh3zra7nh2u6q9weqr80y8ckx8qs9qxpqysgqkxx22u9ape3x6gfqan8y07qgja0ph2h9yqgjhgmudrnu0hp5y2hne4hs7yprmnlsp9x9vhha9hw0xjrxgmp2cc4a0frufmkax70tz2gp9q8fsf",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "15",
            "settle_index":  "15",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "14",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747320671",
                    "resolve_time":  "1747320671",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "e5c8eebaedc9fcf6d7b5be3b8e65304de221f7d3bab9a015d900cef21f1631c1",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "91c39539a1872451364dc7e51f44410be851e2c42949697e67c85329a98537c8",
            "r_hash":  "87a505ccfd3f5b83c6dda988fd8944741a96a8b5e4e4b2284e5ce5e11c04619d",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747320687",
            "settle_date":  "1747320687",
            "payment_request":  "lnbcrt5u1p5ztlm0pp5s7jstn8a8adc83ka4xy0mz2ywsdfd294unjty2zwtnj7z8qyvxwsdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp565tvcvlap27w4920ppgx77ewhv7gusg6q8luqh00330nr573tljs9qxpqysgqgp66f3lqxzqflnv5mtdg8fra8e7qrhyxz8h5n9wd90acj245c9m330q997t69qe86yk0znufkuskvhpz9yk393rsw3nfx63w3nqg8wgpncuke4",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "16",
            "settle_index":  "16",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "15",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747320687",
                    "resolve_time":  "1747320687",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "d516cc33fd0abcea954f08506f7b2ebb3c8e411a01ffc05def8c5f31d3d15fe5",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "94b3ccde09c6ac8b148773367d1b632f888bb3d5107a64db3bfb76b3b629702d",
            "r_hash":  "4081f5aea3f1f1a590adc7b4f8e9c3ab3a84b548516ef19c7dca1c735a82575e",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747320889",
            "settle_date":  "1747320889",
            "payment_request":  "lnbcrt5u1p5zvqpepp5gzqltt4r78c6ty9dc76036wr4vagfd2g29h0r8raegw8xk5z2a0qdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp520jwccdr7258mkc0dy3kwnl590huedwlrn2uqe04p66j8lt60agq9qxpqysgq4nq4tay03k9x827sdyc2xkt3q539jzjr6nnqr8m58ru5pdljn9ppm4p0wdnfhs5ztl7n8dzrs78l9ksjf5lzj24xft0nvc27cwy9t0qpg8rdlg",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "17",
            "settle_index":  "17",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "16",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747320889",
                    "resolve_time":  "1747320889",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "53e4ec61a3f2a87ddb0f6923674ff42befccb5df1cd5c065f50eb523fd7a7f50",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "8372ec1a7cc3a6cbbdde32cca8f0b2874dbb1e2f16aa8919cabd9f3bd08c83ee",
            "r_hash":  "87bf8da694d18e93da9ebccdd6b1e2c16caf4e4c8540cd0c1951fd81a8e61624",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747320995",
            "settle_date":  "1747320995",
            "payment_request":  "lnbcrt5u1p5zvq9rpp5s7lcmf556x8f8k57hnxadv0zc9k27njvs4qv6rqe287cr28xzcjqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp582wucpe2rf3dvmxhp699ad569xt5fq0hq8w9ncv0tn6hz0as83eq9qxpqysgqmwqn8l8499m2jud2zrl9sstypjfw03ujkyeszxflekp6fmwq3qf9rujj4quafphrycqmdljk6tc20mtf4nm74u7xf3xc588mqnel5qsq7z0vmf",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "18",
            "settle_index":  "18",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "17",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747320995",
                    "resolve_time":  "1747320995",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "3a9dcc072a1a62d66cd70e8a5eb69a29974481f701dc59e18f5cf5713fb03c72",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "bef7ce3203f0c31a2cb1b38013463c4625c680a90a2647d0c3a9fb8d6cccea93",
            "r_hash":  "15f538214ce3c8ec1201842662699d8d65ef0b35a9b24b16f5578afc47f9b0f0",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747321100",
            "settle_date":  "1747321100",
            "payment_request":  "lnbcrt5u1p5zvqgvpp5zh6nsg2vu0ywcyspssnxy6va34j77ze44xeyk9h42790c3lekrcqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5qfkvf3p5qssmg0658tl3qsu5lsz7ymrc4hcch6gtmh4kr2xfn7eq9qxpqysgqda3k7mnqgrh4fv9x5y8adu2nrkd8recejy9geudwd9h0gtrk3cah45gdkj6rm9ktx35t4k378kykm8shdrpjd8vgxg385g22hhn67gqppavnd3",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "19",
            "settle_index":  "19",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "18",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747321100",
                    "resolve_time":  "1747321100",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "026cc4c4340421b43f543aff104394fc05e26c78adf18be90bddeb61a8c99fb2",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "fd42e6c28f0612001c37aa8e766abdfe5bd9581a31a57119afb4e5e4f0bd5ddd",
            "r_hash":  "42661269e720bd22709acc0db13feb82999a432ad308d9df69261c12998bed1f",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747321139",
            "settle_date":  "1747321139",
            "payment_request":  "lnbcrt5u1p5zvqfnpp5gfnpy608yz7jyuy6esxmz0lts2ve5se26vydnhmfycwp9xvta50sdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5y3msj77aj2pcxn5d09n3pj8x3zx5j43s0j8ancudw0njq2h8k89q9qxpqysgqu5hjzcpx0qad3nv2ulfpc0n9dpm05hx3v7pm3gkq2z93q6gmh9cr3dv42zxr6mzg5pk4dxwpy5zhty2lzz3uz6ld4wk0jzf7khehgvqqzkgmp6",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "20",
            "settle_index":  "20",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "19",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747321139",
                    "resolve_time":  "1747321139",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "2477097bdd9283834e8d796710c8e6888d4956307c8fd9e38d73e7202ae7b1ca",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "3128ceb36e52aadd82aad23190c655b0046fe7d8676c3bd909774c54116ccfd7",
            "r_hash":  "f06d4186d51d0803ebf10590fffaac6e8ccea7e8f105da15acb1e7dff0b17de4",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747321322",
            "settle_date":  "1747321322",
            "payment_request":  "lnbcrt5u1p5zvq02pp57pk5rpk4r5yq86l3qkg0l74vd6xvaflg7yza59dvk8nalu930hjqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5hjay4l6gg0a3rmde7jj8hawl0tczdja5wh0a455jkzkh27vp4ztq9qxpqysgq9n9p2cjm8286u0fhk667t0f4axfhzy57vg2l6kq4dvv2fhccjx44asr6rtstkqz4gj600qtds4vwdhp7wwc80grs9aczvk5qh73g4eqq0s93gl",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "21",
            "settle_index":  "21",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "20",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747321322",
                    "resolve_time":  "1747321322",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "bcba4aff4843fb11edb9f4a47bf5df7af026cbb475dfdad292b0ad757981a896",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "1453592423fbaa0663421bf543c0fb9a98b544ee04aaa7e60bec0bb904160bd2",
            "r_hash":  "a94e8977819b2d5a256f18993378a4121f2ce1a756bfc7c1ca832d1645735efb",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747321525",
            "settle_date":  "1747321525",
            "payment_request":  "lnbcrt5u1p5zvq44pp5498gjaupnvk45ft0rzvnx79yzg0jecd826lu0sw2svk3v3tntmasdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5kp3xy5x3uznemk3vesmljz8zdge23xun9e34cvrldq6x45tnjv4s9qxpqysgqupl3vaqveq7z83vn40p5yl07sur57ppsam3z6pqqy6zgq3luc5gyd7e4vmgnvcxvtxn4prd0ejz9vp274yf879ggwd7xvrcqapdf55cph9lhc2",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "22",
            "settle_index":  "22",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "21",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747321525",
                    "resolve_time":  "1747321525",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "b0626250d1e0a79dda2ccc37f908e26a32a89b932e635c307f68346ad173932b",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "24d998d2cb14ad459c1236d764dd02daccf12d7b6c68ff968605af4fcb17b973",
            "r_hash":  "24a69b8e9e9c24a36a3c517e18fa1eac89294e0733c96e3c4650f998960a6832",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747321570",
            "settle_date":  "1747321570",
            "payment_request":  "lnbcrt5u1p5zvqhzpp5yjnfhr57nsj2x63u29lp37s74jyjjns8x0yku0zx2rue39s2dqeqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5lcgxhmellymf3c9wur507eaqpgl3c7cqchpwqzhwcl4cgfp8ymss9qxpqysgqjtccgj5f0a9fsfmldcssnygk9a6dq77t6er30272ynnegzp70txhvuzj7y2j25fhlss9ufvuqttgmtjwh3c8u8rslnajnkj5q7u4l3qqquaga0",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "23",
            "settle_index":  "23",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "22",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747321570",
                    "resolve_time":  "1747321570",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "fe106bef3ff93698e0aee0e8ff67a00a3f1c7b00c5c2e00aeec7eb84242726e1",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "8e85ea9f1eee71fd4332db395f3e3960cdc13dd5ecf3e4178719946b25420954",
            "r_hash":  "6f409ee110d38810b21a2f0a4a5f4556619db7927a5bd91094a008d3a493a7ff",
            "value":  "300",
            "value_msat":  "300000",
            "settled":  true,
            "creation_date":  "1747321696",
            "settle_date":  "1747321696",
            "payment_request":  "lnbcrt3u1p5zvqmqpp5daqfacgs6wyppvs69u9y5h692esemduj0fdajyy55qyd8fyn5llsdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp57tj2gwmwxk5gtghdgg85d254lecwjyx0qkjnwjnhwrg6cwdypgqq9qxpqysgqr7c589dx5uhmy5a076fyepe9qg4kmf5rsnm3lygpzhg0g8azaxdxk2dzxm3pewjw5arxvehxg4k7xnsz4e9q4fvej2752p9xymqpmssq8e29ka",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "24",
            "settle_index":  "24",
            "amt_paid":  "300000",
            "amt_paid_sat":  "300",
            "amt_paid_msat":  "300000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "23",
                    "amt_msat":  "300000",
                    "accept_height":  131,
                    "accept_time":  "1747321696",
                    "resolve_time":  "1747321696",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "300000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "f2e4a43b6e35a885a2ed420f46aa95fe70e910cf05a5374a7770d1ac39a40a00",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "852c6ff8f13c4b778baa08fedcb40e840daa60872d447566ef069f93d9fa436c",
            "r_hash":  "dc8b3c1a1b0ee9122aa856ea69f58593fc04dbb960a3908daf1231d9461c3eaa",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747321963",
            "settle_date":  "1747321963",
            "payment_request":  "lnbcrt5u1p5zvprtpp5mj9ncxsmpm53y24g2m4xnav9j07qfkaevz3eprd0zgcaj3su864qdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5xusa4vt5s3muc0nvsgnq3579xgu4yh9kyx0g9gpzuyegl3kqkxgq9qxpqysgqfk2hvruexw45tauj7yrt0s9u59g65xgpqn22davjmqdawsahwys56d4r8unx802k4zc6489vr0djtzy65d7c9kanlnuahgur99a47tgqlczwgf",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "25",
            "settle_index":  "25",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "24",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747321963",
                    "resolve_time":  "1747321963",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "3721dab1748477cc3e6c822608d3c53239525cb6219e82a022e1328fc6c0b190",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "404087346dac385167f69db35d3cbcee8c2cdecd9b8dda3c144683fff31cd7ad",
            "r_hash":  "5159a1424bbf3b3b7e48e258039ce16534f8e1e477bb55e3dad5f09d7a2a044e",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747322192",
            "settle_date":  "1747322192",
            "payment_request":  "lnbcrt5u1p5zvp2spp529v6zsjthuankljgufvq888pv5603c0yw7a4tc766hcf6732q38qdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5v8ndse65z3zfj4xz78maj33t59g4l26t6qcc7la4p2d0ryy3l4hs9qxpqysgq0mskuej5la4xwguq604v442m0z5a3cl0z4kh8e5cg4r5vxjwqhqsn3y93h286aylyjnc9p5d9cntj9yvx004fkze009qpdezarp8wpcpcptqsd",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "26",
            "settle_index":  "26",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "25",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747322192",
                    "resolve_time":  "1747322192",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "61e6d8675414449954c2f1f7d9462ba1515fab4bd0318f7fb50a9af19091fd6f",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "9c693cd46512a07b77964a884e499bae2e3dfa7686bee565dbb151d6e9d25acc",
            "r_hash":  "89b80cb620d8217d009efd980b36ee8e49ee0e13e0dfad4320b2a7ef1fb1f692",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747322418",
            "settle_date":  "1747322418",
            "payment_request":  "lnbcrt5u1p5zvp3jpp53xuqed3qmqsh6qy7lkvqkdhw3ey7ursnur066seqk2n778a376fqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5gnsvtlv08m6uc7vkuzn3fuc0fxxsju5zlezela0v9e0e44u3wm7s9qxpqysgqa7zv6n4vtq76jn3ynev8g7hc86tek70mshx2vlkgmaj46g6g62aztazwh8s8u0lj945kum7jgzrzeqaawpxy5wyycm0lvqmgvkddv3qq7l72ye",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "27",
            "settle_index":  "27",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "26",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747322418",
                    "resolve_time":  "1747322418",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "44e0c5fd8f3ef5cc7996e0a714f30f498d097282fe459ff5ec2e5f9ad79176fd",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "70eb177545a6a842003bfbd51b5ffbf8baa4e55de2881e40289ef56a84c3e6ff",
            "r_hash":  "7637ede93f846efd788782531de3e413a54985f3cc1e0baa14ce8ee761133774",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747322534",
            "settle_date":  "1747322534",
            "payment_request":  "lnbcrt5u1p5zvp4xpp5wcm7m6fls3h067y8sff3mclyzwj5np0nes0qh2s5e68wwcgnxa6qdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5jx9cx3y9pc860mce23779ykhfz0da36p8sdkwq4unflr6s8k5qcq9qxpqysgq4cs9klp3sy7w9txg3ygkpzk3rj9uy4ynn8v5kfd862j3zlquw8n55tcuvhsr6zkmv45ehwprkazd3txavlwgh6kzedzhc2jh272aa3gp035rcx",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "28",
            "settle_index":  "28",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "27",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747322534",
                    "resolve_time":  "1747322534",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "918b8344850e0fa7ef19547de292d7489edec7413c1b6702bc9a7e3d40f6a030",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "ed31c03b1a2a4d96e0ae5463ddeb342126a8ce14eade8541156aec53811d2c85",
            "r_hash":  "5aac465b27dfb5fc74e676576def4e761f18c3b9236fda80d036963db8dccc0b",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747323046",
            "settle_date":  "1747323047",
            "payment_request":  "lnbcrt5u1p5zvz9xpp5t2kyvke8m76lca8xwetkmm6wwc033saeydha4qxsx6trmwxues9sdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5ffj5jjcvg7mt7a59649d7kkn8rtm08asd2excxhykq6gvyh27fes9qxpqysgqa8cyjutaglz275jkrgjzzyx977fmyrs97pnajcga5ev8xn3uu2qzpr3sc3wy9z3n0z4pz3xcdsf0ev2y3kkshqpw3juw8qcqmlywlrqqh299n6",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "29",
            "settle_index":  "29",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "28",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747323047",
                    "resolve_time":  "1747323047",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "4a65494b0c47b6bf7685d54adf5ad338d7b79fb06ab26c1ae4b0348612eaf273",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "5d73b7e3b5ba66f2378e41805feaf2832c6bbfac8268bc3696ec52e9f17da84d",
            "r_hash":  "406849a1bf663bc987aec9c2c0b26a7e965d4421b56342ed44b8cd01b1209283",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747323488",
            "settle_date":  "1747323488",
            "payment_request":  "lnbcrt5u1p5zvznqpp5gp5yngdlvcaunpawe8pvpvn206t963ppk4359m2yhrxsrvfqj2psdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5650whl9tvnh7qe6lx3d3u7tw7ge4y593nanzcpfq5xtnndt44wlq9qxpqysgqx69hw3h8fr9p69xps3djve77nqnxruhl96vr0n89vfrmxzhcltz9y54za305n65wxk4f6a5selzdj7p5qhqjwppdtepvjcmdd2nkhacql6lsf5",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "30",
            "settle_index":  "30",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "29",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747323488",
                    "resolve_time":  "1747323488",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "d51eebfcab64efe0675f345b1e796ef2335250b19f662c0520a19739b575abbe",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "b5f9b14bddc3496bdeb803450d895864154945c06d9c9d53aaba360fc130d6c2",
            "r_hash":  "68c1510fd23de75defdcc11cfa5403da19ae07d2dd34572ae1f23589a57b8234",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747323511",
            "settle_date":  "1747323511",
            "payment_request":  "lnbcrt5u1p5zvznhpp5drq4zr7j8hn4mm7ucyw054qrmgv6up7jm569w2hp7g6cnftmsg6qdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5n8twz4dq8zeamdylcxxzmacw6kcmjtfnevr75f20ysvsh2qxj97s9qxpqysgqqxhcs4kpqpers5pma6v68qgn863llmvsgjcyana2gv70d2x5plh4jydzp8syur7aan7w3lqhusd3us90ay8wmsj9pr9r6qxnuljqzmsqe7wvvn",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "31",
            "settle_index":  "31",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "30",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747323511",
                    "resolve_time":  "1747323511",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "99d6e155a038b3ddb49fc18c2df70ed5b1b92d33cb07ea254f24190ba806917d",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "9b609a129fb40e6329b6803c4be486e1dd90399454e82aeb0ced69ccda14a75d",
            "r_hash":  "acc3a5df8b65c03be4bc3b82a076e6ac6af19ca94195e077a7445cec612895e8",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747324108",
            "settle_date":  "1747324108",
            "payment_request":  "lnbcrt5u1p5zvrxvpp54np6thutvhqrhe9u8wp2qahx4340r89fgx27qaa8g3wwccfgjh5qdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp508pxn2uwshpzvndwj6u8ee7qacfcrsclzky6m75d80q3dkxskk4s9qxpqysgqtnxshwg2d6ldlhf7l3klxzev3axyuv38kcrecy2wzgxyghatyqgnt0ynmxzzxj54u8qvlhd0pakmz48fx0g2efqwscssj5j8hlvz0ycpdr3lyx",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "32",
            "settle_index":  "32",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "31",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747324108",
                    "resolve_time":  "1747324108",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "79c269ab8e85c2264dae96b87ce7c0ee1381c31f1589adfa8d3bc116d8d0b5ab",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "f83c7d1f84002cc4fa9846ed110cc5217e3ba393902ec90ada215c68f8ddca1f",
            "r_hash":  "67aef8ef34a2403aa2417f212a96444e53bafcea7c3909d4a06514684b04ebc3",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747324149",
            "settle_date":  "1747324149",
            "payment_request":  "lnbcrt5u1p5zvr84pp5v7h03me55fqr4gjp0usj49jyfefm4l820susn49qv52xsjcya0psdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5hx06r9luyjcyuyktuuqwf0ycjt378vcxdjq3fgwudyeujkp0gv6q9qxpqysgqq8n0jv02cmnhxf5t86r5vs7qa6p2lxaykt7x570rujzh4xsu3lyx7rknflgtaq4h386pjemf0fp38aqw25y9atlksn9veyvt8ahcxjsp30tdwd",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "33",
            "settle_index":  "33",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "32",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747324149",
                    "resolve_time":  "1747324149",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "b99fa197fc24b04e12cbe700e4bc9892e3e3b3066c8114a1dc6933c9582f4334",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "9bb7a00d613f7ac5ec73cf39e18c58316d065d61a3eb66b60c6354b45a55b8da",
            "r_hash":  "d1bf81bc55e39cb649ee620f2a82e976c23f5b1bf10a3055b7de9204b79d5c4e",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747324235",
            "settle_date":  "1747324235",
            "payment_request":  "lnbcrt5u1p5zvr2tpp56xlcr0z4uwwtvj0wvg8j4qhfwmpr7kcm7y9rq4dhm6fqfduat38qdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp526ka0p42e95e7azuu8duzcz7w8ept56klgu5xrj95rznwly9vcdq9qxpqysgqgne8ta82za5nun2h5rac6p60at0txyg7mta7knsss29yg77j68jjzsm48x76fu20uk0cjur56l3a38y89thplcd8rlause7zttgmpmqqr5u22n",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "34",
            "settle_index":  "34",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "33",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747324235",
                    "resolve_time":  "1747324235",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "56add786aac9699f745ce1dbc1605e71f215d356fa39430e45a0c5377c85661a",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "004c6addd48cbcb5c4b9606dcdb6e4cad5e00c79a56b213c2b06fdc20226ca0e",
            "r_hash":  "be79aa8f219555147f6338abc8133e2dbec60f4077a8a37a9e48c26003052446",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747324384",
            "settle_date":  "1747324384",
            "payment_request":  "lnbcrt5u1p5zvr0qpp5heu64repj423glmr8z4usye79klvvr6qw752x757frpxqqc9y3rqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5q2d4qu60g4l50zdskgpzp84t7n5vd2tnzp8s4hfpe9d5u02gzeps9qxpqysgqr069478xy8p7346c6qc87xrd0na6pmjsnft675pxpyvwvhlqvarsqauk4nupwp5c4vmqsm3apwp4k2r4d8kl6tjpp9909fw5pnupl3qqgqqtlt",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "35",
            "settle_index":  "35",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "34",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747324384",
                    "resolve_time":  "1747324384",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "029b50734f457f4789b0b202209eabf4e8c6a973104f0add21c95b4e3d481643",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "8c838f4719868a2dc0bcae3724696aae1ec91ba3f03e7774930082c075097acd",
            "r_hash":  "bf2ad6733694c1f3402cfc3a81a50998baa85ddbf962f1127afee03a00b8218e",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747324433",
            "settle_date":  "1747324433",
            "payment_request":  "lnbcrt5u1p5zvrs3pp5hu4dvuekjnqlxspvlsagrfgfnza2shwml930zyn6lmsr5q9cyx8qdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5cqvkeua8ryfe02e8desy6q7yzsg2klznas78hreaych2tpd87srq9qxpqysgq6whupqchumyfpve83vj0jzq2a02nwmp90za8tleqhzrypvla0t3554huh76hqv4eqhcl6td8fug99m2gf52r0k3hxc6herfuh6xk3rsqx40snp",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "36",
            "settle_index":  "36",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "35",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747324433",
                    "resolve_time":  "1747324433",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "c0196cf3a7191397ab276e604d03c41410ab7c53ec3c7b8f3d262ea585a7f406",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "df4321e8ac533a530c8cda09afd93c983834b130daa012d8d530b3405d08e403",
            "r_hash":  "341bacdbc88c7b600d0423b0a6d1c70080206b56568eb8c7c144403b783f57e7",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747324438",
            "settle_date":  "1747324438",
            "payment_request":  "lnbcrt5u1p5zvrskpp5xsd6ek7g33akqrgyywc2d5w8qzqzq66k268t337pg3qrk7pl2lnsdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp50pyaf2d2tczhgkhm7k9ar6l622dz5886fy66xkv4fnsvma8qlcxs9qxpqysgqjss403f5gfp2nvtnuh6u46erq6qtxum4dk66d3ugm39cxp7njupjnggxhhpufajg7uelejh83l5fycmhleqcap36ktkavzed8utcw2cqxgzksk",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "37",
            "settle_index":  "37",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "36",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747324438",
                    "resolve_time":  "1747324438",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "7849d4a9aa5e05745afbf58bd1ebfa529a2a1cfa4935a359954ce0cdf4e0fe0d",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "df9098074fdd9898d6499625fcd928ea9b9c760ceedddf806fb11beeccb7e5a9",
            "r_hash":  "c36844ab80bdd2e5dba37ec396e78571ee49e04596de6322262881c8aa264660",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747324642",
            "settle_date":  "1747324642",
            "payment_request":  "lnbcrt5u1p5zvrhzpp5cd5yf2uqhhfwtkar0mpedeu9w8hyncz9jm0xxg3x9zqu323xgesqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5q4ncn3js7f8qvuk8yzeqkyvwfd7edszewpx2ltxq7pauru8aj2ls9qxpqysgqkzzav8a6l6l20zhmntge8ysgn7wvg2ang0nn0pfkr5uyhe2nhwj5ceuxtg76m2t6h9ezu00z99amtamz3zh43pulg2w8uutthaj78uqql6lwgs",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "38",
            "settle_index":  "38",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "37",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747324642",
                    "resolve_time":  "1747324642",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "056789c650f24e0672c720b20b118e4b7d96c059704cafacc0f07bc1f0fd92bf",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "f03d95ab233e878013b8e31efeb536085ed6f671f07fe0c99f43e40cc78f42b3",
            "r_hash":  "ad1e9fe65baa9b2649512cbbcdc39a675db08d727de068e05626a966e2e06d45",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747324647",
            "settle_date":  "1747324648",
            "payment_request":  "lnbcrt5u1p5zvrh8pp5450flejm42djvj239jaumsu6vawmprtj0hsx3czky65kdchqd4zsdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5rpnmnnpzkwwrmugk6dluup6unfs43epqa7pcqt4asu5ulez8k80s9qxpqysgqkt6x6y8p6e6td0wvt4c0nnue4de5xcj7znrtq5ra0ftqlquv4lk87kq9t5hm5nqhrsvu2s6ndwmhs9xlr9kzuzr8x86hshn2mgcpg9qp5gznfl",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "39",
            "settle_index":  "39",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "38",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747324648",
                    "resolve_time":  "1747324648",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "1867b9cc22b39c3df116d37fce075c9a6158e420ef83802ebd8729cfe447b1df",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "0910eb91adb2f50d7c7632eba9d12a182300d2e71f19a1ac530668c7d8b7ec65",
            "r_hash":  "72e4d54da172460c1768a365e95dcc1556a49d220f04b67c0be0771581ae4a5a",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747324654",
            "settle_date":  "1747324654",
            "payment_request":  "lnbcrt5u1p5zvrhwpp5wtjd2ndpwfrqc9mg5dj7jhwvz4t2f8fzpuztvlqtupm3tqdwffdqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp57h4reeyrsp90wnze7j6gsvf356uyhqpaxmef5m27mt7946wnx6gq9qxpqysgq54yp38834sm4ze69nv439s798ymh84hpx0c50zfw7rxddts3sqh9q0ka0pedfhve4vnur4rx9h9vnqan9uk2p3crjek8ant5m0qw8ksp2ku7aj",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "40",
            "settle_index":  "40",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "39",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747324654",
                    "resolve_time":  "1747324654",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "f5ea3ce483804af74c59f4b4883131a6b84b803d36f29a6d5edafc5ae9d33690",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "fb46f9be2db21aaabf9973b424637b37510afec635ab46ac9424c563aff5df5c",
            "r_hash":  "9c4b9c25d90b03cef92488a978700553fdf325338d789cf4f4d7798957bbaf2a",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747324697",
            "settle_date":  "1747324697",
            "payment_request":  "lnbcrt5u1p5zvrcepp5n39ecfwepvpua7fy3z5hsuq9207lxffn34ufea856aucj4am4u4qdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5rrt3v7pu9cn2tltrlcf4nj544f2yjptcez87kzl269dxyzjny9zs9qxpqysgq4hjpcxj97lcjsnp9pg5edy9vlvpx00d9046vmu07em3u46lm47hxna8z6dn3vamsa9cps7q5jq4wm2f9a5m8rdkwrqxx26grwk8gt9cqss9hcc",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "41",
            "settle_index":  "41",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "40",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747324697",
                    "resolve_time":  "1747324697",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "18d716783c2e26a5fd63fe1359ca95aa54490578c88feb0bead15a620a532145",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "7b4247f8f46adec3e3c4b1cc2f8c596c19e2b16609aac825b21bbb72d2cef13f",
            "r_hash":  "e35e4b790fd1fbaf8b0f070a1ee33e4914b6f117c756669810b03ed22dafa4e0",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747324823",
            "settle_date":  "1747324823",
            "payment_request":  "lnbcrt5u1p5zvruhpp5ud0yk7g068a6lzc0qu9pace7fy2tdughcatxdxqskqldytd05nsqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5r6v6sy064wsdrdjcwygt0x2ykum8unqfc9c4k76g7y2w3smxqfss9qxpqysgqwrxxwhg5l6wlc0dnn76r5ql80zuxgtdgm3jsfsnsjw9dpdahfddnyw75ggdwsscezr4ddlkdes7reygnq3gt0nm9zc9hv83j8eszkusqk0tf7c",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "42",
            "settle_index":  "42",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "41",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747324823",
                    "resolve_time":  "1747324823",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "1e99a811faaba0d1b6587110b79944b7367e4c09c1715b7b48f114e8c3660261",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "002649bf5f7a7058253b1d2213ddc0b1b2d6a16c0ce6aac7630db6e07952b206",
            "r_hash":  "6cb657aab12c3dde67d9e7863535df8b5e061b30d0a609ac8afab38d7f003424",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747325309",
            "settle_date":  "1747325309",
            "payment_request":  "lnbcrt5u1p5zvytapp5djm902439s7aue7eu7rr2dwl3d0qvxes6znqnty2l2ec6lcqxsjqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5ujne74qsc68rw0edjzaz2gjezulwhdpv6lxewjc802pj80n7x8tq9qxpqysgq4my3fd4m58dvzy6y2qdurdgcx6ykvq3x0rupgt262cs0nu7djxhx9925gk90cstymyafz7mvhsyxc7jj8m50dvrhwljtjmv3e6jqakgqmuuvxu",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "43",
            "settle_index":  "43",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "42",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747325309",
                    "resolve_time":  "1747325309",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "e4a79f5410c68e373f2d90ba252259173eebb42cd7cd974b077a8323be7e31d6",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "c6b4bca79d54f4bab864a3415c82a3550441895065f4987517d2d0574e22de0f",
            "r_hash":  "613153f85f39f4dcb468c262d593c7c8b9f5033850b5244d63efb9e06891c50d",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747325314",
            "settle_date":  "1747325314",
            "payment_request":  "lnbcrt5u1p5zvyvzpp5vyc487zl886dedrgcf3dty78ezul2qec2z6jgntra7u7q6y3c5xsdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5vtrju0ngl23t94uwd55hdsqd4heyf787tf5vp5ezfe6eu93wwdgs9qxpqysgqntepyytg85y9tf9a7sjjek3xgaj7a4zs6mxhyhn36t5r0nhrxhdys854v3nysyfftafa5s4dukd3v58qlx8cqjy86lrpftn7uufznwgq4jvm3u",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "44",
            "settle_index":  "44",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "43",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747325314",
                    "resolve_time":  "1747325314",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "62c72e3e68faa2b2d78e6d2976c00dadf244f8fe5a68c0d3224e759e162e7351",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "c0e51b5e0ef31f1acf3807b9978afb8f3e6e270584d50d558efaef146b39eeee",
            "r_hash":  "637d0021c9a611c873a209db3e549705875deea9bc1f16ac812dfea7790582cb",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747325712",
            "settle_date":  "1747325712",
            "payment_request":  "lnbcrt5u1p5zvycspp5vd7sqgwf5cgusuazp8dnu4yhqkr4mm4fhs03dtyp9hl2w7g9st9sdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp5jl4zmv8r0hrw92l8eaz8zs2kl834whql8haq627dnnlv7qwellaq9qxpqysgqhdrkltzfc53kyakkdfhcrncy2y8e8rycttvezeadpefgksdsn7m5aaevcm7g8tdqp6qvc882s7k6rf6g4ze9uy6kfltsxz7gcw3d4zcpnewfq2",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "45",
            "settle_index":  "45",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "44",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747325712",
                    "resolve_time":  "1747325712",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "97ea2db0e37dc6e2abe7cf44714156f9e3575c1f3dfa0d2bcd9cfecf01d9fffa",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        },
        {
            "memo":  "Prueba desde test_lightpen_api",
            "r_preimage":  "e6e59d9fc4a86198b073195fb8c46eed3682d4810a4d24041ca0b1acd379c33e",
            "r_hash":  "9ec613b35f87c2bf27e1435ed4957705a64d0a00c98e6bac8cda2b5431777130",
            "value":  "500",
            "value_msat":  "500000",
            "settled":  true,
            "creation_date":  "1747325798",
            "settle_date":  "1747325798",
            "payment_request":  "lnbcrt5u1p5zvymxpp5nmrp8v6lslpt7flpgd0df9thqkny6zsqex8xhtyvmg44gvthwycqdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp572zr3htjj730hpw6zlvdfr4s55vsn4wlx602fn6vm9xkw2erq39q9qxpqysgqv384g3hs9uvvtfase044zvtdj4nsllkksjgweqddzkklv9mzyq4sjkp59fw4282cntwtaqmtgyqxp87qkcl35jjs92vuew4hygey3lsplc6fm9",
            "description_hash":  "",
            "expiry":  "86400",
            "fallback_addr":  "",
            "cltv_expiry":  "80",
            "route_hints":  [],
            "private":  false,
            "add_index":  "46",
            "settle_index":  "46",
            "amt_paid":  "500000",
            "amt_paid_sat":  "500",
            "amt_paid_msat":  "500000",
            "state":  "SETTLED",
            "htlcs":  [
                {
                    "chan_id":  "138538465165312",
                    "htlc_index":  "45",
                    "amt_msat":  "500000",
                    "accept_height":  131,
                    "accept_time":  "1747325798",
                    "resolve_time":  "1747325798",
                    "expiry_height":  214,
                    "state":  "SETTLED",
                    "custom_records":  {},
                    "mpp_total_amt_msat":  "500000",
                    "amp":  null,
                    "custom_channel_data":  ""
                }
            ],
            "features":  {
                "8":  {
                    "name":  "tlv-onion",
                    "is_required":  true,
                    "is_known":  true
                },
                "14":  {
                    "name":  "payment-addr",
                    "is_required":  true,
                    "is_known":  true
                },
                "17":  {
                    "name":  "multi-path-payments",
                    "is_required":  false,
                    "is_known":  true
                },
                "25":  {
                    "name":  "route-blinding",
                    "is_required":  false,
                    "is_known":  true
                }
            },
            "is_keysend":  false,
            "payment_addr":  "f28438dd7297a2fb85da17d8d48eb0a51909d5df369ea4cf4cd94d672b23044a",
            "is_amp":  false,
            "amp_invoice_state":  {},
            "is_blinded":  false,
            "blinded_path_config":  null
        }
    ],
    "last_index_offset":  "46",
    "first_index_offset":  "1"
}
[2025-05-15T16:20:43.300806] Comando docker exec exitoso: docker exec lnd1 lncli --network=regtest listchannels
{
    "channels":  [
        {
            "active":  true,
            "remote_pubkey":  "0222ead81c2a784edb24b2657154198ec0009ce8d73b5ec852d97ec18f259c6acc",
            "channel_point":  "7b13c45332506f32ae7f6c032ef69c83846919101d230cd57910f2da99a4c04c:0",
            "chan_id":  "138538465165312",
            "capacity":  "1000000",
            "local_balance":  "22800",
            "remote_balance":  "973730",
            "commit_fee":  "2810",
            "commit_weight":  "1116",
            "fee_per_kw":  "2500",
            "unsettled_balance":  "0",
            "total_satoshis_sent":  "0",
            "total_satoshis_received":  "22800",
            "num_updates":  "92",
            "pending_htlcs":  [],
            "csv_delay":  144,
            "private":  false,
            "initiator":  false,
            "chan_status_flags":  "ChanStatusDefault",
            "local_chan_reserve_sat":  "10000",
            "remote_chan_reserve_sat":  "10000",
            "static_remote_key":  false,
            "commitment_type":  "ANCHORS",
            "lifetime":  "8534",
            "uptime":  "8534",
            "close_address":  "",
            "push_amount_sat":  "0",
            "thaw_height":  0,
            "local_constraints":  {
                "csv_delay":  144,
                "chan_reserve_sat":  "10000",
                "dust_limit_sat":  "354",
                "max_pending_amt_msat":  "990000000",
                "min_htlc_msat":  "1",
                "max_accepted_htlcs":  483
            },
            "remote_constraints":  {
                "csv_delay":  144,
                "chan_reserve_sat":  "10000",
                "dust_limit_sat":  "354",
                "max_pending_amt_msat":  "990000000",
                "min_htlc_msat":  "1",
                "max_accepted_htlcs":  483
            },
            "alias_scids":  [],
            "zero_conf":  false,
            "zero_conf_confirmed_scid":  "0",
            "peer_alias":  "lnd2",
            "peer_scid_alias":  "0",
            "memo":  "",
            "custom_channel_data":  ""
        }
    ]
}
[2025-05-15T16:20:43.379787] Fallo en comando docker exec: docker exec lnd2 lncli --network=regtest listchannels
STDOUT: 
STDERR: [lncli] rpc error: code = Unavailable desc = connection error: desc = "transport: Error while dialing: dial tcp 127.0.0.1:10009: connect: connection refused"

[2025-05-15T16:20:43.387233] Invoice creada: payment_request=lnbcrt5u1p5zv9zmpp5usfnuewx5tam589hexjxuuuwnv9a20rs9lrfh0dnyvpq098xcd3qdps2pe82etzvysxgetnv3jjqar9wd697mrfva58gur9de0kzurfcqzzsxqyz5vqsp58chj6cy6zqwfdqjwd0khxe68gm9vmsf8ektrzv643m5s4zmy4cgq9qxpqysgqhch20xq2vh8u53w3wau72twjgqu7j5rswym6ann2tnsxztnlycl897jk7lcyh45cs6fm4kt46ulnye03qughh8a5t2j44jfnkfyu3jgqqd0y4j | r_hash=5BM+Zcai+7oct8mkbnOOmwvVPHAvxpu9syMCB5Tmw2I=
[2025-05-15T16:20:43.387429] Valores de payment_hash - HEX: e4133e65c6a2fbba1cb7c9a46e738e9b0bd53c702fc69bbdb323020794e6c362 | B64: 5BM+Zcai+7oct8mkbnOOmwvVPHAvxpu9syMCB5Tmw2I=
[2025-05-15T16:20:43.540195] Pago enviado desde lnd2: payment_error= | status=ok
[2025-05-15T16:20:43.546146] Consulta estado de invoice (e4133e65c6a2fbba1cb7c9a46e738e9b0bd53c702fc69bbdb323020794e6c362): settled=True
[2025-05-15T16:20:43.546402] Invoice settled detectado en intento 1
[2025-05-15T16:20:45.564547] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:20:45.564640] Intento 1: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:20:46.079823] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:20:46.079951] Intento 2: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:20:47.093772] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:20:47.093883] Intento 3: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:20:49.107364] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:20:49.107471] Intento 4: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:20:53.122730] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:20:53.122845] Intento 5: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:20:58.134695] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:20:58.134815] Intento 6: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:21:03.148151] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:21:03.148310] Intento 7: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:21:08.160018] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:21:08.160163] Intento 8: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:21:13.172276] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:21:13.172395] Intento 9: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:21:18.184366] Error al llamar a /invoices/: status=400, response={"detail":"Pago no confirmado"}
[2025-05-15T16:21:18.184466] Intento 10: Pago a√∫n no reconocido por Lightpen
[2025-05-15T16:21:23.184793] Lightpen no reconoci√≥ el pago a tiempo


----- Fichero: ./main.py -----
# main.py

# 1) Lo primero: cargar el .env
from app.core.config import load_config
load_config()

# 2) Ahora importamos el resto con la certeza de que DATABASE_URL existe
from fastapi import FastAPI
from app.routes import invoices, receipts
from app.core.auth import verify_api_key
from app.core.db import init_db
import logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("app")

# 3) Inicializar la base de datos (create_all o migraciones)
init_db()

app = FastAPI(
    title="Generador de Recibo Lightning",
    version="0.1.0"
)

@app.on_event("startup")
async def startup_event():
    logger.info("üöÄ App arrancada, ready to receive requests")

# Middleware para API Key (usamos el verify_api_key que retorna call_next)
app.middleware("http")(verify_api_key)

# Rutas principales
app.include_router(invoices.router, prefix="/invoices", tags=["Invoices"])
app.include_router(receipts.router, prefix="/receipts", tags=["Receipts"])

if __name__ == "__main__":
    import uvicorn
    uvicorn.run("main:app", host="0.0.0.0", port=8000, reload=True)


----- Fichero: ./pyproject.toml -----
[project]
name = "lightpen"
version = "0.1.0"
description = "Add your description here"
readme = "README.md"
requires-python = ">=3.12"
dependencies = []


----- Fichero: ./README.md -----


----- Fichero: ./requirements.txt -----
fastapi
uvicorn
sqlalchemy
python-dotenv
psycopg2-binary
weasyprint
stripe
python-multipart
httpx

Jinja2
requests
pydantic
alembic
lndgrpc

----- Fichero: ./seed_data.py -----
# seed_data.py

# 1) Cargamos .env para que DATABASE_URL est√© disponible antes de cualquier import
from dotenv import load_dotenv
load_dotenv()

from datetime import datetime, timedelta
from app.core.db import SessionLocal, init_db
from app.models import Tenant, APIKey, Invoice, Receipt

def seed():
    # 2) Crea tablas si hacen falta
    init_db()

    db = SessionLocal()
    try:
        # 3) Crear tenant de prueba
        tenant = Tenant(
            name="Acme Corp",
            email="admin@acme.local",
            plan="monthly",
            next_billing=datetime.utcnow() + timedelta(days=30),
            is_active=True
        )
        db.add(tenant)
        db.commit()
        db.refresh(tenant)

        # 4) Generar API key de prueba
        api_key = APIKey(
            tenant_id=tenant.id,
            key_hash="test-key-123",
            expires_at=datetime.utcnow() + timedelta(days=90),
            is_active=True
        )
        db.add(api_key)
        db.commit()

        # 5) Crear una factura y su recibo
        invoice = Invoice(
            tenant_id=tenant.id,
            payment_hash="0000abcd1234",
            amount_msat=150000,
            description="Pago de prueba",
            customer_name="Cliente Demo",
            status="paid"
        )
        db.add(invoice)
        db.commit()
        db.refresh(invoice)

        receipt = Receipt(
            invoice_id=invoice.id,
            pdf_url=f"./generated_receipts/{invoice.id}.pdf",
            signature="dummy-sign-5678"
        )
        db.add(receipt)
        db.commit()

        print("‚úÖ Datos de prueba creados:")
        print(f"   Tenant.id:  {tenant.id}")
        print(f"   APIKey:     {api_key.key_hash}")
        print(f"   Invoice.id: {invoice.id}")
        print(f"   Receipt.id: {receipt.id}")

    finally:
        db.close()

if __name__ == "__main__":
    seed()


----- Fichero: ./templates/receipt.html -----
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <style>
      body { font-family: sans-serif; margin: 2rem; }
      h1 { text-align: center; }
      .field { margin-bottom: 1rem; }
      .label { font-weight: bold; }
    </style>
  </head>
  <body>
    <h1>Recibo Lightning</h1>
    <div class="field"><span class="label">ID:</span> {{ invoice_id }}</div>
    <div class="field"><span class="label">Cliente:</span> {{ cliente }}</div>
    <div class="field"><span class="label">Monto (msat):</span> {{ monto_msat }}</div>
    <div class="field"><span class="label">Descripci√≥n:</span> {{ descripcion }}</div>
    <div class="field"><span class="label">Hash:</span> {{ payment_hash }}</div>
    <div class="field"><span class="label">Firma:</span> {{ firma }}</div>
  </body>
</html>


----- Fichero: ./test_grpc_add_invoice.py -----
import os
import time
import json
import subprocess
import requests
from app.services.lnd_grpc import LndGrpcClient

API_URL = "http://localhost:8000/invoices"
API_KEY = os.getenv("API_KEY", "test-key-123")


def run(*args):
    return subprocess.run(args, capture_output=True, text=True)

def get_lnd2_new_address():
    result = run("docker", "exec", "lnd2", "lncli", "--network=regtest", "--rpcserver=localhost:10010", "newaddress", "p2wkh")
    return json.loads(result.stdout)["address"]

def send_to_address(address):
    return run("docker", "exec", "bitcoind", "bitcoin-cli", "-regtest", "-rpcuser=bitcoin", "-rpcpassword=bitcoin", "sendtoaddress", address, "1.0")

def mine_blocks(n=6):
    addr = run("docker", "exec", "bitcoind", "bitcoin-cli", "-regtest", "-rpcuser=bitcoin", "-rpcpassword=bitcoin", "getnewaddress").stdout.strip()
    run("docker", "exec", "bitcoind", "bitcoin-cli", "-regtest", "-rpcuser=bitcoin", "-rpcpassword=bitcoin", "generatetoaddress", str(n), addr)

def check_wallet_balance():
    result = run("docker", "exec", "lnd2", "lncli", "--network=regtest", "--rpcserver=localhost:10010", "walletbalance")
    data = json.loads(result.stdout)
    return int(data["confirmed_balance"])

def connect_peers(pubkey):
    run("docker", "exec", "lnd2", "lncli", "--network=regtest", "--rpcserver=localhost:10010", "connect", f"{pubkey}@lnd1:9735")

def open_channel(pubkey):
    return run("docker", "exec", "lnd2", "lncli", "--network=regtest", "--rpcserver=localhost:10010", "openchannel", "--node_key="+pubkey, "--local_amt=1000000")

def list_channels():
    result = run("docker", "exec", "lnd2", "lncli", "--network=regtest", "--rpcserver=localhost:10010", "listchannels")
    return json.loads(result.stdout)["channels"]

if __name__ == "__main__":
    print("üì° Obteniendo pubkey de LND1...")
    pubkey = json.loads(run("docker", "exec", "lnd1", "lncli", "--network=regtest", "getinfo").stdout)["identity_pubkey"]

    print("üîó Conectando LND2 a LND1...")
    connect_peers(pubkey)

    if check_wallet_balance() < 1000000:
        print("üí∏ Fondeando LND2...")
        address = get_lnd2_new_address()
        send_to_address(address)
        mine_blocks(6)
        time.sleep(2)

    if not list_channels():
        print("ü™ü Abriendo canal...")
        open_channel(pubkey)
        mine_blocks(6)
        time.sleep(2)

    # Crear invoice y pagarla
    lnd1 = LndGrpcClient()
    lnd2 = LndGrpcClient(
        ip_address="localhost:10010",
        macaroon_path="./docker/lnd/lnd2-data/data/chain/bitcoin/regtest/admin.macaroon",
        cert_path="./docker/lnd/lnd2-data/tls.cert"
    )

    print("üöÄ Creando invoice gRPC por 500 sats...")
    invoice = lnd1.add_invoice(amount_sat=500, memo="Prueba v√≠a gRPC")
    print(f"üì¶ payment_request: {invoice['payment_request']}")
    print(f"üîë r_hash: {invoice['r_hash']}")

    print("‚ö°Ô∏è LND2 intentando pagar la invoice...")
    payment = lnd2.client.send_payment(invoice['payment_request'])
    print(f"üí∏ Estado del pago: {payment.payment_error or 'OK'}")

    print("‚è≥ Esperando que la invoice sea pagada...")
    for attempt in range(10):
        invoice_status = lnd1.lookup_invoice(invoice["r_hash"])
        print(f"üîç Intento {attempt + 1}: settled={invoice_status['settled']}")
        if invoice_status["settled"]:
            print("‚úÖ Invoice pagada.")
            break
        time.sleep(2)
    else:
        print("‚ùå La invoice no fue pagada a tiempo.")
        exit(1)

    # ‚¨áÔ∏è Enviar la invoice al backend y verificar recibo
    print("üì® Enviando invoice al backend para generar recibo...")
    payload = {
        "payment_hash": invoice["r_hash"],
        "amount_msat": 500 * 1000,
        "description": "Prueba v√≠a gRPC",
        "customer_name": "Test User"
    }
    headers = {"x-api-key": API_KEY}

    response = requests.post(API_URL, json=payload, headers=headers)
    if response.status_code != 200:
        print(f"‚ùå Error en la creaci√≥n del recibo: {response.status_code} {response.text}")
        exit(1)

    data = response.json()
    print("üìÑ Recibo generado:")
    print(f"üßæ invoice_id: {data['invoice_id']}")
    print(f"üìé receipt_id: {data['receipt_id']}")
    print(f"üîó receipt_url: {data['receipt_url']}")
    print(f"üñã ALL: {data}")

----- Fichero: ./test.py -----
import os
import time
import requests
import base64
import subprocess
from dotenv import load_dotenv
from datetime import datetime

load_dotenv()

API_URL = "http://localhost:8000"
API_KEY = os.getenv("LIGHTPEN_API_KEY", "test-key-123")
HEADERS = {"x-api-key": API_KEY}
LND1_REST = "https://localhost:8080"
LND2_REST = "https://localhost:8081"

TLS_CERT_PATH = os.getenv("LND_TLS_CERT_PATH")
LOGFILE = "lightpen_test_log.txt"


def log_event(text):
    timestamp = datetime.utcnow().isoformat()
    with open(LOGFILE, "a") as f:
        f.write(f"[{timestamp}] {text}\n")


def run_docker_command(cmd):
    try:
        result = subprocess.run(cmd, capture_output=True, text=True, check=True)
        log_event(f"Comando docker exec exitoso: {' '.join(cmd)}\n{result.stdout.strip()}")
    except subprocess.CalledProcessError as e:
        log_event(f"Fallo en comando docker exec: {' '.join(cmd)}\nSTDOUT: {e.stdout}\nSTDERR: {e.stderr}")


def get_macaroon(path):
    with open(path, "rb") as f:
        return f.read().hex()


MACAROON_LND1 = {"Grpc-Metadata-macaroon": get_macaroon("./docker/lnd/lnd1-data/data/chain/bitcoin/regtest/admin.macaroon")}
MACAROON_LND2 = {"Grpc-Metadata-macaroon": get_macaroon("./docker/lnd/lnd2-data/data/chain/bitcoin/regtest/admin.macaroon")}


def wait_for_lightpen(timeout=10):
    log_event("Esperando disponibilidad de Lightpen")
    print(f"‚è≥ Esperando que Lightpen est√© disponible en {API_URL}...")
    for i in range(timeout):
        try:
            r = requests.post(f"{API_URL}/invoices/", timeout=2)
            if r.status_code in [401, 422]:
                print("üü¢ Lightpen responde")
                log_event("Lightpen responde correctamente")
                return
        except requests.ConnectionError:
            print(f"  ‚Üí Intento {i+1}/{timeout}: a√∫n no disponible...")
            log_event(f"Intento {i+1}: Lightpen no disponible")
        time.sleep(1)
    log_event("No se pudo conectar a Lightpen")
    print(f"‚ùå No se pudo conectar a Lightpen en {API_URL}")
    exit(1)


def is_invoice_settled(payment_hash_hex: str) -> bool:
    url = f"{LND1_REST}/v1/invoice/{payment_hash_hex}"
    r = requests.get(url, headers=MACAROON_LND1, verify=TLS_CERT_PATH)
    r.raise_for_status()
    data = r.json()
    settled = data.get("settled", False)
    log_event(f"Consulta estado de invoice ({payment_hash_hex}): settled={settled}")
    return settled


def create_invoice_lnd1():
    print("üìú Creando invoice en lnd1...")
    payload = {
        "value_msat": 500000,
        "memo": "Prueba desde test_lightpen_api"
    }
    r = requests.post(f"{LND1_REST}/v1/invoices", json=payload, headers=MACAROON_LND1, verify=TLS_CERT_PATH)
    r.raise_for_status()
    data = r.json()
    log_event(f"Invoice creada: payment_request={data['payment_request']} | r_hash={data['r_hash']}")
    print("üì¶ Invoice:", data["payment_request"])
    return data["r_hash"], data["payment_request"]


def pay_invoice_lnd2(payment_request):
    print("üí∏ Pagando invoice desde lnd2...")
    payload = {"payment_request": payment_request}
    r = requests.post(f"{LND2_REST}/v1/channels/transactions", json=payload, headers=MACAROON_LND2, verify=False)
    r.raise_for_status()
    data = r.json()
    log_event(f"Pago enviado desde lnd2: payment_error={data.get('payment_error')} | status=ok")
    print("‚úÖ Pago enviado:", data.get("payment_error") or "sin error")


def call_lightpen_api(payment_hash_b64):
    print("üì± Llamando a /invoices/ de lightpen...")
    payload = {
        "payment_hash": payment_hash_b64,
        "amount_msat": 500_000,
        "description": "Recibo de prueba",
        "customer_name": "Cliente Test"
    }
    curl_payload = '{"payment_hash": "%s", "amount_msat": 500000, "description": "Recibo de prueba", "customer_name": "Cliente Test"}' % payment_hash_b64
    curl_command = (
        f"curl -X POST {API_URL}/invoices/ \\\n         -H 'Content-Type: application/json' \\\n         -H 'x-api-key: {API_KEY}' \\\n         -d \"{curl_payload}\""
    )
    print("\nü™ô Ejecutar manualmente con curl si es necesario:\n" + curl_command + "\n")
    r = requests.post(f"{API_URL}/invoices/", json=payload, headers=HEADERS)
    if r.status_code != 200:
        log_event(f"Error al llamar a /invoices/: status={r.status_code}, response={r.text}")
        print("‚ùå Error al llamar a /invoices/")
        print(f"Status: {r.status_code}")
        print("Response:", r.text)
        r.raise_for_status()
    data = r.json()
    log_event(f"Recibo generado exitosamente: {data}")
    print("üìå Recibo generado:", data)
    return data


def wait_for_payment_confirmation(payment_hash_b64, max_attempts=10):
    for attempt in range(max_attempts):
        print(f"üîÅ Intentando registrar pago ({attempt+1}/{max_attempts})...")
        try:
            data = call_lightpen_api(payment_hash_b64)
            print("‚úÖ Recibo generado con √©xito")
            return data
        except requests.HTTPError as e:
            if e.response.status_code == 400 and "Pago no confirmado" in e.response.text:
                print("  ‚Ü™Ô∏è Lightpen todav√≠a no lo reconoce como settled. Esperando...")
                log_event(f"Intento {attempt+1}: Pago a√∫n no reconocido por Lightpen")
                time.sleep(min(5, 0.5 * 2**attempt))
                continue
            log_event(f"Error HTTP inesperado en call_lightpen_api: {e}")
            raise
    log_event("Lightpen no reconoci√≥ el pago a tiempo")
    print("‚ùå El pago no fue reconocido por Lightpen a tiempo.")
    exit(1)


def download_receipt(receipt_url):
    print(f"üóÖÔ∏è Descargando PDF desde: {receipt_url}")
    if os.path.isfile(receipt_url):
        with open(receipt_url, "rb") as fsrc:
            with open("recibo_test.pdf", "wb") as fdst:
                fdst.write(fsrc.read())
        print("‚úÖ Recibo copiado como recibo_test.pdf")
        log_event(f"Recibo copiado localmente desde ruta directa: {receipt_url}")
    else:
        r = requests.get(receipt_url, headers=HEADERS)
        if r.status_code == 200:
            with open("recibo_test.pdf", "wb") as f:
                f.write(r.content)
            print("‚úÖ Recibo guardado como recibo_test.pdf")
            log_event(f"Recibo descargado exitosamente desde {receipt_url}")
        else:
            print("‚ö†Ô∏è No se pudo descargar el recibo:", r.status_code)
            log_event(f"Fallo al descargar recibo desde {receipt_url} | status={r.status_code}")


if __name__ == "__main__":
    wait_for_lightpen()

    run_docker_command(["docker", "exec", "lnd1", "lncli", "--network=regtest", "listinvoices"])
    run_docker_command(["docker", "exec", "lnd1", "lncli", "--network=regtest", "listchannels"])
    run_docker_command(["docker", "exec", "lnd2", "lncli", "--network=regtest", "listchannels"])

    r_hash_raw, payment_request = create_invoice_lnd1()

    if isinstance(r_hash_raw, str):
        payment_hash_hex = base64.b64decode(r_hash_raw).hex()
        payment_hash_b64 = r_hash_raw
    else:
        payment_hash_hex = r_hash_raw.hex()
        payment_hash_b64 = base64.b64encode(r_hash_raw).decode()

    print("üßê Enviando payment_hash a Lightpen:", payment_hash_hex)
    print("üîç Consultando estado con payment_hash (base64):", payment_hash_b64)
    log_event(f"Valores de payment_hash - HEX: {payment_hash_hex} | B64: {payment_hash_b64}")

    pay_invoice_lnd2(payment_request)

    for i in range(10):
        if is_invoice_settled(payment_hash_hex):
            print(f"‚úÖ Invoice settled en intento {i+1}")
            log_event(f"Invoice settled detectado en intento {i+1}")
            break
        time.sleep(2)
    else:
        log_event("Invoice no settled en LND1 tras m√∫ltiples intentos")
        print("‚ùå El pago no fue settled en LND1 a tiempo.")
        exit(1)

    print("üïí Esperando propagaci√≥n de pago a Lightpen...")
    time.sleep(2)

    print("‚è≥ Esperando que el pago sea reconocido por lightpen...")
    data = wait_for_payment_confirmation(payment_hash_b64, max_attempts=10)

    if data.get("receipt_url"):
        download_receipt(data["receipt_url"])
        log_event(f"Recibo final registrado y descargado: {data['receipt_url']}")


